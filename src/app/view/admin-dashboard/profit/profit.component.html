<!-- ==========================================
FICHIER: src/app/view/admin-dashboard/benefice/benefice.component.html
DESCRIPTION: Template du composant de gestion des b√©n√©fices
========================================== -->

<div class="benefice-container">

  <!-- ========== EN-T√äTE ========== -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <span class="icon">üí∞</span>
          Analyse des B√©n√©fices
        </h1>
        <p class="page-subtitle">
          P√©riode: {{ getPeriodLabel() }}
        </p>
      </div>
      <div class="header-right">
        <button class="btn btn-secondary" (click)="toggleFilters()">
          <span class="icon">üîç</span>
          {{ showFilters ? 'Masquer' : 'Afficher' }} Filtres
        </button>
        <button class="btn btn-primary" (click)="exportToCSV()">
          <span class="icon">üìä</span>
          Exporter CSV
        </button>
        <button class="btn btn-primary" (click)="exportToPDF()">
          <span class="icon">üìÑ</span>
          Imprimer
        </button>
      </div>
    </div>
  </div>

  <!-- ========== FILTRES ========== -->
  <div class="filters-section" *ngIf="showFilters">
    <div class="filters-card">
      <h3 class="filters-title">üîç Filtres</h3>

      <!-- P√©riode -->
      <div class="filter-group">
        <h4 class="filter-label">üìÖ P√©riode</h4>
        <div class="filter-row">
          <div class="form-group">
            <label>Type de p√©riode</label>
            <select
              [(ngModel)]="periodType"
              (ngModelChange)="onPeriodTypeChange()"
              class="form-control">
              <option value="mensuel">Mensuel</option>
              <option value="trimestriel">Trimestriel</option>
              <option value="annuel">Annuel</option>
              <option value="personnalise">Personnalis√©</option>
            </select>
          </div>

          <!-- Mensuel -->
          <div class="form-group" *ngIf="periodType === 'mensuel'">
            <label>Mois</label>
            <select
              [(ngModel)]="selectedMonth"
              (ngModelChange)="onMonthChange()"
              class="form-control">
              <option *ngFor="let month of months" [value]="month.value">
                {{ month.label }}
              </option>
            </select>
          </div>

          <!-- Trimestriel -->
          <div class="form-group" *ngIf="periodType === 'trimestriel'">
            <label>Trimestre</label>
            <select
              [(ngModel)]="selectedQuarter"
              (ngModelChange)="onQuarterChange()"
              class="form-control">
              <option *ngFor="let quarter of quarters" [value]="quarter.value">
                {{ quarter.label }}
              </option>
            </select>
          </div>

          <!-- Ann√©e (pour mensuel, trimestriel, annuel) -->
          <div class="form-group" *ngIf="periodType !== 'personnalise'">
            <label>Ann√©e</label>
            <select
              [(ngModel)]="selectedYear"
              (ngModelChange)="onYearChange()"
              class="form-control">
              <option *ngFor="let year of availableYears" [value]="year">
                {{ year }}
              </option>
            </select>
          </div>

          <!-- P√©riode personnalis√©e -->
          <div class="form-group" *ngIf="periodType === 'personnalise'">
            <label>Date de d√©but</label>
            <input
              type="date"
              [(ngModel)]="customStartDate"
              (ngModelChange)="onPeriodTypeChange()"
              class="form-control">
          </div>

          <div class="form-group" *ngIf="periodType === 'personnalise'">
            <label>Date de fin</label>
            <input
              type="date"
              [(ngModel)]="customEndDate"
              (ngModelChange)="onPeriodTypeChange()"
              class="form-control">
          </div>
        </div>
      </div>

      <!-- Filtres de crit√®res -->
      <div class="filter-group">
        <h4 class="filter-label">üéØ Crit√®res</h4>
        <div class="filter-grid">
          <!-- Cave -->
          <div class="form-group">
            <label>Cave</label>
            <select
              [(ngModel)]="selectedCave"
              (ngModelChange)="onCaveChange()"
              class="form-control">
              <option value="all">Toutes les caves</option>
              <option *ngFor="let cave of caves" [value]="cave.id">
                {{ cave.name }}
              </option>
            </select>
          </div>

          <!-- Cat√©gorie -->
          <div class="form-group">
            <label>Cat√©gorie</label>
            <select
              [(ngModel)]="selectedCategory"
              (ngModelChange)="onCategoryChange()"
              class="form-control">
              <option value="all">Toutes</option>
              <option *ngFor="let category of drinkCategories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>

          <!-- Fournisseur -->
          <div class="form-group">
            <label>Fournisseur</label>
            <select
              [(ngModel)]="selectedSupplier"
              (ngModelChange)="onSupplierChange()"
              class="form-control">
              <option value="all">Tous</option>
              <option *ngFor="let supplier of suppliers" [value]="supplier">
                {{ supplier }}
              </option>
            </select>
          </div>

          <!-- Format -->
          <div class="form-group">
            <label>Format</label>
            <select
              [(ngModel)]="selectedFormat"
              (ngModelChange)="onFormatChange()"
              class="form-control">
              <option value="all">Tous</option>
              <option *ngFor="let format of formats" [value]="format">
                {{ format }}
              </option>
            </select>
          </div>

          <!-- Conditionnement -->
          <div class="form-group">
            <label>Conditionnement</label>
            <select
              [(ngModel)]="selectedBulkUnit"
              (ngModelChange)="onBulkUnitChange()"
              class="form-control">
              <option value="all">Tous</option>
              <option *ngFor="let unit of bulkUnits" [value]="unit">
                {{ unit }}
              </option>
            </select>
          </div>

          <!-- Boisson -->
          <div class="form-group">
            <label>Boisson</label>
            <select
              [(ngModel)]="selectedDrink"
              (ngModelChange)="onDrinkChange()"
              class="form-control">
              <option value="all">Toutes</option>
              <option *ngFor="let drink of drinks" [value]="drink.id">
                {{ drink.icon }} {{ drink.name }}
              </option>
            </select>
          </div>

          <!-- Cat√©gorie de d√©pense -->
          <div class="form-group">
            <label>Cat√©gorie d√©pense</label>
            <select
              [(ngModel)]="selectedExpenseCategory"
              (ngModelChange)="onExpenseCategoryChange()"
              class="form-control">
              <option value="all">Toutes</option>
              <option *ngFor="let cat of expenseCategories" [value]="cat">
                {{ cat }}
              </option>
            </select>
          </div>

          <!-- Recherche -->
          <div class="form-group">
            <label>Recherche</label>
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (ngModelChange)="onSearchChange()"
              placeholder="Rechercher..."
              class="form-control">
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="resetFilters()">
          <span class="icon">üîÑ</span>
          R√©initialiser
        </button>
        <button class="btn btn-primary" (click)="applyFilters()">
          <span class="icon">‚úÖ</span>
          Appliquer
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ALERTES ========== -->
  <div class="alerts-section" *ngIf="getAlerts().length > 0">
    <div class="alert alert-warning" *ngFor="let alert of getAlerts()">
      {{ alert }}
    </div>
  </div>

  <!-- ========== RECOMMANDATIONS ========== -->
  <div class="recommendations-section" *ngIf="getRecommendations().length > 0">
    <div class="recommendations-card">
      <h3 class="card-title">üí° Recommandations</h3>
      <ul class="recommendations-list">
        <li *ngFor="let rec of getRecommendations()">{{ rec }}</li>
      </ul>
    </div>
  </div>

  <!-- ========== NAVIGATION VUES ========== -->
  <div class="view-tabs">
    <button
      class="tab-btn"
      [class.active]="viewMode === 'global'"
      (click)="switchView('global')">
      <span class="icon">üìä</span>
      Vue Globale
    </button>
    <button
      class="tab-btn"
      [class.active]="viewMode === 'details'"
      (click)="switchView('details')">
      <span class="icon">üìã</span>
      D√©tails par Produit
    </button>
  </div>

  <!-- ========== VUE GLOBALE ========== -->
  <div class="global-view" *ngIf="viewMode === 'global'">

    <!-- Statistiques principales -->
    <div class="stats-grid">
      <!-- Chiffre d'affaires -->
      <div class="stat-card stat-primary">
        <div class="stat-icon">üíµ</div>
        <div class="stat-content">
          <div class="stat-label">Chiffre d'Affaires</div>
          <div class="stat-value">{{ formatCurrency(globalStats.chiffreAffaires) }}</div>
          <div class="stat-detail">{{ globalStats.nombreVentes }} vente(s)</div>
        </div>
      </div>

      <!-- B√©n√©fice Net -->
      <div class="stat-card stat-success">
        <div class="stat-icon">{{ getStatusIcon(globalStats.beneficeNet) }}</div>
        <div class="stat-content">
          <div class="stat-label">B√©n√©fice Net</div>
          <div class="stat-value" [class]="getStatusClass(globalStats.beneficeNet)">
            {{ formatCurrency(globalStats.beneficeNet) }}
          </div>
          <div class="stat-detail">Marge: {{ formatPercentage(globalStats.margeNette) }}</div>
        </div>
      </div>

      <!-- Total Co√ªts -->
      <div class="stat-card stat-danger">
        <div class="stat-icon">üí∏</div>
        <div class="stat-content">
          <div class="stat-label">Co√ªts Totaux</div>
          <div class="stat-value">{{ formatCurrency(globalStats.coutTotal) }}</div>
          <div class="stat-detail">
            Achats + D√©penses + Pertes
          </div>
        </div>
      </div>

      <!-- Marge Nette -->
      <div class="stat-card stat-info">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <div class="stat-label">Marge Nette</div>
          <div class="stat-value" [class]="getStatusClass(globalStats.margeNette)">
            {{ formatPercentage(globalStats.margeNette) }}
          </div>
          <div class="stat-detail">Rentabilit√© globale</div>
        </div>
      </div>
    </div>

    <!-- D√©tails des revenus et co√ªts -->
    <div class="details-grid">
      <!-- Revenus -->
      <div class="detail-card">
        <h3 class="card-title">üí∞ Revenus</h3>
        <div class="detail-list">
          <div class="detail-item">
            <span class="detail-label">Ventes totales</span>
            <span class="detail-value">{{ formatCurrency(globalStats.chiffreAffaires) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Nombre de ventes</span>
            <span class="detail-value">{{ globalStats.nombreVentes }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Panier moyen</span>
            <span class="detail-value">{{ formatCurrency(globalStats.panierMoyen) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Prix moyen de vente</span>
            <span class="detail-value">{{ formatCurrency(globalStats.prixMoyenVente) }}</span>
          </div>
        </div>
      </div>

      <!-- Co√ªts -->
      <div class="detail-card">
        <h3 class="card-title">üí∏ Co√ªts</h3>
        <div class="detail-list">
          <div class="detail-item">
            <span class="detail-label">Achats (marchandises)</span>
            <span class="detail-value text-danger">{{ formatCurrency(globalStats.totalAchats) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">D√©penses (op√©rationnelles)</span>
            <span class="detail-value text-danger">{{ formatCurrency(globalStats.totalDepenses) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Pertes (casse, p√©remption)</span>
            <span class="detail-value text-danger">{{ formatCurrency(globalStats.totalPertes) }}</span>
          </div>
          <div class="detail-item total-item">
            <span class="detail-label"><strong>Total co√ªts</strong></span>
            <span class="detail-value text-danger"><strong>{{ formatCurrency(globalStats.coutTotal) }}</strong></span>
          </div>
        </div>
      </div>

      <!-- Stock -->
      <div class="detail-card">
        <h3 class="card-title">üì¶ Stock</h3>
        <div class="detail-list">
          <div class="detail-item">
            <span class="detail-label">Stock de d√©part (valeur)</span>
            <span class="detail-value">{{ formatCurrency(globalStats.stockDepart) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Stock restant (valeur)</span>
            <span class="detail-value">{{ formatCurrency(globalStats.stockRestant) }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Boissons achet√©es</span>
            <span class="detail-value">{{ globalStats.totalBoissonsAchetees }} unit√©s</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Boissons vendues</span>
            <span class="detail-value">{{ globalStats.totalBoissonsVendues }} unit√©s</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Boissons perdues</span>
            <span class="detail-value text-danger">{{ globalStats.totalBoissonsPertes }} unit√©s</span>
          </div>
        </div>
      </div>

      <!-- Marges -->
      <div class="detail-card">
        <h3 class="card-title">üìä Marges</h3>
        <div class="detail-list">
          <div class="detail-item">
            <span class="detail-label">B√©n√©fice brut</span>
            <span class="detail-value" [class]="getStatusClass(globalStats.beneficeBrut)">
              {{ formatCurrency(globalStats.beneficeBrut) }}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Marge brute</span>
            <span class="detail-value" [class]="getStatusClass(globalStats.margeBrute)">
              {{ formatPercentage(globalStats.margeBrute) }}
            </span>
          </div>
          <div class="detail-item total-item">
            <span class="detail-label"><strong>B√©n√©fice net</strong></span>
            <span class="detail-value" [class]="getStatusClass(globalStats.beneficeNet)">
              <strong>{{ formatCurrency(globalStats.beneficeNet) }}</strong>
            </span>
          </div>
          <div class="detail-item total-item">
            <span class="detail-label"><strong>Marge nette</strong></span>
            <span class="detail-value" [class]="getStatusClass(globalStats.margeNette)">
              <strong>{{ formatPercentage(globalStats.margeNette) }}</strong>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Analyses compl√©mentaires -->
    <div class="analysis-grid">
      <!-- Top performeurs -->
      <div class="analysis-card">
        <h3 class="card-title">üèÜ Top 5 - Meilleurs b√©n√©fices</h3>
        <div class="ranking-list">
          <div class="ranking-item" *ngFor="let item of getTopPerformers(5); let i = index">
            <span class="rank">{{ i + 1 }}</span>
            <span class="item-icon">{{ item.drinkIcon }}</span>
            <span class="item-name">{{ item.drinkName }}</span>
            <span class="item-value text-success">{{ formatCurrency(item.benefice) }}</span>
          </div>
          <div class="no-data" *ngIf="getTopPerformers(5).length === 0">
            Aucune donn√©e disponible
          </div>
        </div>
      </div>

      <!-- Plus vendus -->
      <div class="analysis-card">
        <h3 class="card-title">üî• Top 5 - Plus vendus</h3>
        <div class="ranking-list">
          <div class="ranking-item" *ngFor="let item of getMostSoldDrinks(5); let i = index">
            <span class="rank">{{ i + 1 }}</span>
            <span class="item-icon">{{ item.drinkIcon }}</span>
            <span class="item-name">{{ item.drinkName }}</span>
            <span class="item-value">{{ item.quantiteVendue }} unit√©s</span>
          </div>
          <div class="no-data" *ngIf="getMostSoldDrinks(5).length === 0">
            Aucune donn√©e disponible
          </div>
        </div>
      </div>

      <!-- Meilleures marges -->
      <div class="analysis-card">
        <h3 class="card-title">üíé Top 5 - Meilleures marges</h3>
        <div class="ranking-list">
          <div class="ranking-item" *ngFor="let item of getHighestMarginDrinks(5); let i = index">
            <span class="rank">{{ i + 1 }}</span>
            <span class="item-icon">{{ item.drinkIcon }}</span>
            <span class="item-name">{{ item.drinkName }}</span>
            <span class="item-value text-success">{{ formatPercentage(item.margePourcentage) }}</span>
          </div>
          <div class="no-data" *ngIf="getHighestMarginDrinks(5).length === 0">
            Aucune donn√©e disponible
          </div>
        </div>
      </div>

      <!-- Moins performants -->
      <div class="analysis-card">
        <h3 class="card-title">‚ö†Ô∏è Top 5 - Moins performants</h3>
        <div class="ranking-list">
          <div class="ranking-item" *ngFor="let item of getLowPerformers(5); let i = index">
            <span class="rank">{{ i + 1 }}</span>
            <span class="item-icon">{{ item.drinkIcon }}</span>
            <span class="item-name">{{ item.drinkName }}</span>
            <span class="item-value text-danger">{{ formatCurrency(item.benefice) }}</span>
          </div>
          <div class="no-data" *ngIf="getLowPerformers(5).length === 0">
            Aucune donn√©e disponible
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== VUE D√âTAILS ========== -->
  <div class="details-view" *ngIf="viewMode === 'details'">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Boisson</th>
            <th>Cat√©gorie</th>
            <th>Format</th>
            <th>Fournisseur</th>
            <th class="text-right">Qt√© Achet√©e</th>
            <th class="text-right">Qt√© Vendue</th>
            <th class="text-right">Qt√© Perdue</th>
            <th class="text-right">Stock</th>
            <th class="text-right">Co√ªt Achat</th>
            <th class="text-right">Revenue Vente</th>
            <th class="text-right">B√©n√©fice</th>
            <th class="text-right">Marge %</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of itemStats; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <div class="item-cell">
                <span class="item-icon">{{ item.drinkIcon }}</span>
                <span class="item-name">{{ item.drinkName }}</span>
              </div>
            </td>
            <td>{{ item.category }}</td>
            <td>{{ item.format }}</td>
            <td>{{ item.supplier }}</td>
            <td class="text-right">{{ item.quantiteAchetee }}</td>
            <td class="text-right">{{ item.quantiteVendue }}</td>
            <td class="text-right text-danger">{{ item.quantitePerdue }}</td>
            <td class="text-right">{{ item.stockActuel }}</td>
            <td class="text-right">{{ formatCurrency(item.coutAchat) }}</td>
            <td class="text-right">{{ formatCurrency(item.revenueVente) }}</td>
            <td class="text-right" [class]="getStatusClass(item.benefice)">
              <strong>{{ formatCurrency(item.benefice) }}</strong>
            </td>
            <td class="text-right" [class]="getStatusClass(item.margePourcentage)">
              <strong>{{ formatPercentage(item.margePourcentage) }}</strong>
            </td>
          </tr>
          <tr *ngIf="itemStats.length === 0">
            <td colspan="13" class="no-data">
              Aucune donn√©e disponible pour la p√©riode s√©lectionn√©e
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========== LOADER ========== -->
  <div class="loader-overlay" *ngIf="isLoading">
    <div class="loader">
      <div class="spinner"></div>
      <p>Chargement des donn√©es...</p>
    </div>
  </div>

</div>
