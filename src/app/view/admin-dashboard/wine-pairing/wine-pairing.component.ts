import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';

/**
 * Interface pour d√©finir un accord mets & vins
 */
interface WinePairing {
  id: string;
  category: string; // Type de plat: Viandes, Poissons, Fromages, etc.
  dish: string; // Nom du plat
  dishIcon: string; // Emoji du plat
  wine: string; // Nom du vin
  wineIcon: string; // Emoji du vin
  wineType: string; // Type: Rouge, Blanc, Ros√©, etc.
  description: string; // Description de l'accord
  temperature: string; // Temp√©rature de service
  region?: string; // R√©gion viticole
  vintage?: string; // Mill√©sime recommand√©
  tags?: string[]; // Tags pour recherche
  rating?: number; // Note de l'accord (1-5)
  createdAt: Date;
}

/**
 * Interface pour le formulaire d'ajout d'accord
 */
interface WinePairingForm {
  category: string;
  dish: string;
  dishIcon: string;
  wine: string;
  wineIcon: string;
  wineType: string;
  description: string;
  temperature: string;
  region: string;
  vintage: string;
  tags: string[];
}

/**
 * Composant WinePairing - Gestion des accords mets & vins
 * Permet de cr√©er, consulter et g√©rer les associations plats-vins
 */
@Component({
  selector: 'app-wine-pairing',
   standalone: true,
  // Import des modules n√©cessaires
  imports: [CommonModule, FormsModule, ReactiveFormsModule],
  templateUrl: './wine-pairing.component.html',
  styleUrls: ['./wine-pairing.component.scss']
})
export class WinePairingComponent implements OnInit {

  // Liste des accords mets & vins
  winePairings: WinePairing[] = [];

  // Accords filtr√©s (pour la recherche)
  filteredPairings: WinePairing[] = [];

  // Modal d'ajout/√©dition
  isModalOpen: boolean = false;
  isEditMode: boolean = false;
  selectedPairing: WinePairing | null = null;

  // Formulaire
  pairingForm: WinePairingForm = this.getEmptyForm();

  // Filtres et recherche
  searchQuery: string = '';
  selectedCategory: string = 'all';
  selectedWineType: string = 'all';

  // Cat√©gories de plats disponibles
  categories: string[] = [
    'Viandes rouges',
    'Viandes blanches',
    'Poissons',
    'Fruits de mer',
    'Fromages',
    'Desserts',
    'Ap√©ritifs',
    'Plats v√©g√©tariens',
    'Plats √©pic√©s',
    'Charcuterie'
  ];

  // Types de vins
  wineTypes: string[] = [
    'Vin Rouge',
    'Vin Blanc',
    'Vin Ros√©',
    'Champagne',
    'Vin Mousseux',
    'Vin Blanc Liquoreux',
    'Porto',
    'Vin de Glace'
  ];

  // Ic√¥nes disponibles pour les plats
  dishIcons: string[] = [
    'ü•©', 'üçó', 'üêü', 'ü¶û', 'üßÄ', 'üç∞', 'ü•ó', 'üçï', 'üçù', 'üåÆ'
  ];

  // Ic√¥nes disponibles pour les vins
  wineIcons: string[] = [
    'üç∑', 'ü•Ç', 'üçæ', 'üçá', 'üçæ', 'ü•É'
  ];

  // √âtat de chargement
  isLoading: boolean = false;

  constructor() {}

  ngOnInit(): void {
    // Chargement initial des accords
    this.loadWinePairings();
  }

  /**
   * Charge les accords mets & vins depuis le backend
   */
  loadWinePairings(): void {
    this.isLoading = true;

    // TODO: Appel API
    // Simulation avec des donn√©es de test
    this.winePairings = this.generateMockPairings();
    this.filteredPairings = [...this.winePairings];

    this.isLoading = false;
    console.log('Accords charg√©s:', this.winePairings.length);
  }

  /**
   * G√©n√®re des accords de test pour la d√©mo
   * @returns Liste d'accords simul√©s
   */
  private generateMockPairings(): WinePairing[] {
    return [
      {
        id: '1',
        category: 'Viandes rouges',
        dish: 'Steak grill√©',
        dishIcon: 'ü•©',
        wine: 'Bordeaux Rouge',
        wineIcon: 'üç∑',
        wineType: 'Vin Rouge',
        description: 'Un Bordeaux cors√© sublime parfaitement un steak grill√©. Les tanins structur√©s du vin s\'accordent avec la richesse de la viande.',
        temperature: '16-18¬∞C',
        region: 'Bordeaux',
        vintage: '2015-2018',
        tags: ['classique', '√©l√©gant', 'tanins'],
        rating: 5,
        createdAt: new Date()
      },
      {
        id: '2',
        category: 'Poissons',
        dish: 'Saumon grill√©',
        dishIcon: 'üêü',
        wine: 'Chablis',
        wineIcon: 'üç∑',
        wineType: 'Vin Blanc',
        description: 'La fra√Æcheur min√©rale d\'un Chablis compl√®te d√©licatement le go√ªt d√©licat du saumon grill√©.',
        temperature: '10-12¬∞C',
        region: 'Bourgogne',
        vintage: '2019-2021',
        tags: ['frais', 'min√©ral', 'd√©licat'],
        rating: 4,
        createdAt: new Date()
      },
      {
        id: '3',
        category: 'Fromages',
        dish: 'Plateau de fromages affin√©s',
        dishIcon: 'üßÄ',
        wine: 'Porto Tawny',
        wineIcon: 'ü•É',
        wineType: 'Porto',
        description: 'Le Porto Tawny avec ses notes de fruits secs et de caramel s\'accorde merveilleusement avec les fromages affin√©s.',
        temperature: '14-16¬∞C',
        region: 'Porto',
        vintage: '10-20 ans',
        tags: ['intense', 'complexe', 'doux'],
        rating: 5,
        createdAt: new Date()
      },
      {
        id: '4',
        category: 'Fruits de mer',
        dish: 'Hu√Ætres fra√Æches',
        dishIcon: 'ü¶û',
        wine: 'Muscadet',
        wineIcon: 'üç∑',
        wineType: 'Vin Blanc',
        description: 'Un Muscadet sec et iod√© est le compagnon id√©al des hu√Ætres fra√Æches.',
        temperature: '8-10¬∞C',
        region: 'Loire',
        vintage: 'Mill√©sime r√©cent',
        tags: ['iod√©', 'frais', 'maritime'],
        rating: 5,
        createdAt: new Date()
      },
      {
        id: '5',
        category: 'Desserts',
        dish: 'Tarte tatin',
        dishIcon: 'üç∞',
        wine: 'Sauternes',
        wineIcon: 'üç∑',
        wineType: 'Vin Blanc Liquoreux',
        description: 'Un Sauternes moelleux avec ses notes de miel et d\'abricot sublime une tarte tatin aux pommes caram√©lis√©es.',
        temperature: '8-10¬∞C',
        region: 'Bordeaux',
        vintage: '2015-2017',
        tags: ['sucr√©', 'onctueux', 'complexe'],
        rating: 4,
        createdAt: new Date()
      },
      {
        id: '6',
        category: 'Ap√©ritifs',
        dish: 'Olives et tapenade',
        dishIcon: 'ü´í',
        wine: 'Champagne Brut',
        wineIcon: 'ü•Ç',
        wineType: 'Champagne',
        description: 'Les bulles fines d\'un Champagne Brut nettoient le palais entre chaque bouch√©e d\'olives.',
        temperature: '6-8¬∞C',
        region: 'Champagne',
        vintage: 'Non mill√©sim√©',
        tags: ['festif', '√©l√©gant', 'p√©tillant'],
        rating: 4,
        createdAt: new Date()
      }
    ];
  }

  /**
   * Recherche et filtre les accords
   */
  applyFilters(): void {
    let result = [...this.winePairings];

    // Filtre par recherche textuelle
    if (this.searchQuery.trim()) {
      const query = this.searchQuery.toLowerCase();
      result = result.filter(pairing =>
        pairing.dish.toLowerCase().includes(query) ||
        pairing.wine.toLowerCase().includes(query) ||
        pairing.description.toLowerCase().includes(query) ||
        pairing.tags?.some(tag => tag.toLowerCase().includes(query))
      );
    }

    // Filtre par cat√©gorie
    if (this.selectedCategory !== 'all') {
      result = result.filter(pairing => pairing.category === this.selectedCategory);
    }

    // Filtre par type de vin
    if (this.selectedWineType !== 'all') {
      result = result.filter(pairing => pairing.wineType === this.selectedWineType);
    }

    this.filteredPairings = result;
    console.log('Filtres appliqu√©s:', result.length, 'r√©sultats');
  }

  /**
   * G√®re le changement de recherche
   */
  onSearchChange(): void {
    this.applyFilters();
  }

  /**
   * G√®re le changement de cat√©gorie
   */
  onCategoryChange(): void {
    this.applyFilters();
  }

  /**
   * G√®re le changement de type de vin
   */
  onWineTypeChange(): void {
    this.applyFilters();
  }

  /**
   * R√©initialise tous les filtres
   */
  resetFilters(): void {
    this.searchQuery = '';
    this.selectedCategory = 'all';
    this.selectedWineType = 'all';
    this.filteredPairings = [...this.winePairings];
  }

  /**
   * Ouvre le modal d'ajout d'accord
   */
  openAddModal(): void {
    this.isEditMode = false;
    this.selectedPairing = null;
    this.pairingForm = this.getEmptyForm();
    this.isModalOpen = true;
  }

  /**
   * Ouvre le modal d'√©dition d'accord
   * @param pairing - Accord √† √©diter
   */
  openEditModal(pairing: WinePairing): void {
    this.isEditMode = true;
    this.selectedPairing = pairing;
    this.pairingForm = {
      category: pairing.category,
      dish: pairing.dish,
      dishIcon: pairing.dishIcon,
      wine: pairing.wine,
      wineIcon: pairing.wineIcon,
      wineType: pairing.wineType,
      description: pairing.description,
      temperature: pairing.temperature,
      region: pairing.region || '',
      vintage: pairing.vintage || '',
      tags: pairing.tags || []
    };
    this.isModalOpen = true;
  }

  /**
   * Ferme le modal
   */
  closeModal(): void {
    this.isModalOpen = false;
    this.isEditMode = false;
    this.selectedPairing = null;
    this.pairingForm = this.getEmptyForm();
  }

  /**
   * Sauvegarde l'accord (ajout ou modification)
   */
  savePairing(): void {
    // Validation
    if (!this.validateForm()) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }

    if (this.isEditMode && this.selectedPairing) {
      // Mode √©dition
      this.updatePairing();
    } else {
      // Mode ajout
      this.addPairing();
    }
  }

  /**
   * Ajoute un nouvel accord
   */
  private addPairing(): void {
    const newPairing: WinePairing = {
      id: this.generateId(),
      category: this.pairingForm.category,
      dish: this.pairingForm.dish,
      dishIcon: this.pairingForm.dishIcon,
      wine: this.pairingForm.wine,
      wineIcon: this.pairingForm.wineIcon,
      wineType: this.pairingForm.wineType,
      description: this.pairingForm.description,
      temperature: this.pairingForm.temperature,
      region: this.pairingForm.region,
      vintage: this.pairingForm.vintage,
      tags: this.pairingForm.tags,
      rating: 0,
      createdAt: new Date()
    };

    this.winePairings.unshift(newPairing);
    this.applyFilters();

    // TODO: Appel API
    console.log('Accord ajout√©:', newPairing);

    alert('Accord mets & vins ajout√© avec succ√®s !');
    this.closeModal();
  }

  /**
   * Met √† jour un accord existant
   */
  private updatePairing(): void {
    if (!this.selectedPairing) return;

    const index = this.winePairings.findIndex(p => p.id === this.selectedPairing!.id);
    if (index !== -1) {
      this.winePairings[index] = {
        ...this.selectedPairing,
        category: this.pairingForm.category,
        dish: this.pairingForm.dish,
        dishIcon: this.pairingForm.dishIcon,
        wine: this.pairingForm.wine,
        wineIcon: this.pairingForm.wineIcon,
        wineType: this.pairingForm.wineType,
        description: this.pairingForm.description,
        temperature: this.pairingForm.temperature,
        region: this.pairingForm.region,
        vintage: this.pairingForm.vintage,
        tags: this.pairingForm.tags
      };

      this.applyFilters();

      // TODO: Appel API
      console.log('Accord mis √† jour:', this.winePairings[index]);

      alert('Accord mis √† jour avec succ√®s !');
      this.closeModal();
    }
  }

  /**
   * Supprime un accord
   * @param pairing - Accord √† supprimer
   */
  deletePairing(pairing: WinePairing): void {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'accord "${pairing.dish} & ${pairing.wine}" ?`)) {
      this.winePairings = this.winePairings.filter(p => p.id !== pairing.id);
      this.applyFilters();

      // TODO: Appel API
      console.log('Accord supprim√©:', pairing.id);

      alert('Accord supprim√© avec succ√®s');
    }
  }

  /**
   * Valide le formulaire
   * @returns true si le formulaire est valide
   */
  private validateForm(): boolean {
    return !!(
      this.pairingForm.category &&
      this.pairingForm.dish &&
      this.pairingForm.wine &&
      this.pairingForm.wineType &&
      this.pairingForm.description &&
      this.pairingForm.temperature
    );
  }

  /**
   * Retourne un formulaire vide
   * @returns Formulaire initialis√©
   */
  private getEmptyForm(): WinePairingForm {
    return {
      category: '',
      dish: '',
      dishIcon: 'üçΩÔ∏è',
      wine: '',
      wineIcon: 'üç∑',
      wineType: '',
      description: '',
      temperature: '',
      region: '',
      vintage: '',
      tags: []
    };
  }

  /**
   * G√©n√®re un ID unique
   * @returns ID g√©n√©r√©
   */
  private generateId(): string {
    return `pairing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * Ajoute un tag au formulaire
   * @param tag - Tag √† ajouter
   */
  addTag(tag: string): void {
    if (tag && !this.pairingForm.tags.includes(tag)) {
      this.pairingForm.tags.push(tag);
    }
  }

  /**
   * Supprime un tag du formulaire
   * @param tag - Tag √† supprimer
   */
  removeTag(tag: string): void {
    this.pairingForm.tags = this.pairingForm.tags.filter(t => t !== tag);
  }

  /**
   * Retourne les √©toiles de notation
   * @param rating - Note (1-5)
   * @returns Tableau d'√©toiles
   */
  getStars(rating: number): boolean[] {
    return Array(5).fill(false).map((_, index) => index < rating);
  }

  /**
   * Exporte les accords en CSV
   */
  exportToPDF(): void {
    console.log('Export des accords en PDF...');
    // TODO: Impl√©menter l'export CSV
    alert('Accords export√©s avec succ√®s !');
  }

  /**
   * Imprime les accords
   */
  printPairings(): void {
    window.print();
  }
}
