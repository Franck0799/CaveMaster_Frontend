<!-- ===== FICHIER: cave-lists.component.html ===== -->
<!-- Template pour l'affichage et gestion de la liste des caves -->

<div class="cave-lists-container">

  <!-- Message de feedback -->
  <div *ngIf="message"
       class="alert"
       [ngClass]="'alert-' + messageType">
    {{ message }}
  </div>

  <!-- En-tête avec titre et boutons -->
  <div class="header-section">
    <h2>🍷 Mes Caves</h2>
    <button class="btn btn-primary" (click)="openAddCaveModal()">
      ➕ Ajouter une cave
    </button>
  </div>

  <!-- Barre de recherche -->
  <div class="search-section">
    <div class="search-bar">
      <input
        type="text"
        placeholder="🔍 Rechercher une cave par nom ou localisation..."
        [value]="filters.searchTerm"
        (input)="onSearch($any($event.target).value)"
        class="search-input">
    </div>
  </div>

  <!-- Section des filtres -->
  <div class="filters-section">
    <!-- Filtre par région -->
    <select class="filter-select"
            [value]="filters.location"
            (change)="onFilterChange('location', $any($event.target).value)">
      <option value="">Toutes les régions</option>
      <option *ngFor="let region of regions" [value]="region">📍 {{ region }}</option>
    </select>

    <!-- Filtre par capacité -->
    <select class="filter-select"
            [value]="filters.capacity"
            (change)="onFilterChange('capacity', $any($event.target).value)">
      <option value="">Toutes les capacités</option>
      <option value="small">Petite (< 200)</option>
      <option value="medium">Moyenne (200-500)</option>
      <option value="large">Grande (> 500)</option>
    </select>

    <!-- Bouton réinitialiser les filtres -->
    <button (click)="resetFilters()" class="btn btn-secondary">
      ↻ Réinitialiser
    </button>
  </div>

  <!-- Statistiques globales des caves -->
  <div class="caves-stats" *ngIf="filteredCaves.length > 0">
    <div class="stat-box">
      <span class="stat-icon">🏢</span>
      <div class="stat-info">
        <span class="stat-label">Total de caves</span>
        <span class="stat-value">{{ filteredCaves.length }}</span>
      </div>
    </div>

    <div class="stat-box">
      <span class="stat-icon">🍾</span>
      <div class="stat-info">
        <span class="stat-label">Total de bouteilles</span>
        <span class="stat-value">{{ getTotalBottles() }}</span>
      </div>
    </div>

    <div class="stat-box">
      <span class="stat-icon">👥</span>
      <div class="stat-info">
        <span class="stat-label">Total de managers</span>
        <span class="stat-value">{{ getTotalManagers() }}</span>
      </div>
    </div>

    <div class="stat-box">
      <span class="stat-icon">👨‍💼</span>
      <div class="stat-info">
        <span class="stat-label">Total d'employés</span>
        <span class="stat-value">{{ getTotalEmployees() }}</span>
      </div>
    </div>
  </div>

  <!-- Grille de cartes des caves -->
  <div class="caves-grid">
    <!-- Boucle sur chaque cave filtrée -->
    <div *ngFor="let cave of filteredCaves" class="cave-card">

      <!-- En-tête de la carte -->
      <div class="cave-card-header">
        <div class="cave-title">
          <h3>{{ cave.name }}</h3>
          <p class="cave-location">📍 {{ cave.location }}</p>
        </div>
        <!-- Badge de statut -->
        <span class="productivity-badge" [ngClass]="'badge-' + getProductivityLevel(cave.productivity)">
          {{ cave.productivity }}%
        </span>
      </div>

      <!-- Description de la cave -->
      <p class="cave-description">{{ cave.description }}</p>

      <!-- Grille de statistiques -->
      <div class="stats-grid">
        <!-- Bouteilles -->
        <div class="stat-item">
          <span class="stat-label">🍾 Bouteilles</span>
          <span class="stat-value">{{ cave.bottles }}</span>
        </div>
        <!-- Capacité -->
        <div class="stat-item">
          <span class="stat-label">📦 Capacité</span>
          <span class="stat-value">{{ cave.capacity }}</span>
        </div>
        <!-- Managers -->
        <div class="stat-item">
          <span class="stat-label">👥 Managers</span>
          <span class="stat-value">{{ cave.managersCount }}</span>
        </div>
        <!-- Employés -->
        <div class="stat-item">
          <span class="stat-label">👨‍💼 Employés</span>
          <span class="stat-value">{{ cave.employeesCount }}</span>
        </div>
      </div>

      <!-- Barre de taux d'occupation -->
      <div class="occupancy-bar">
        <div class="bar-label">
          <span>Occupation</span>
          <span class="percentage">{{ getOccupancyPercentage(cave) }}%</span>
        </div>
        <div class="bar-container">
          <div class="bar-fill" [style.width.%]="getOccupancyPercentage(cave)"></div>
        </div>
      </div>

      <!-- Actions de la carte -->
      <div class="cave-card-actions">
        <!-- Bouton voir détails -->
        <button (click)="viewCaveDetails(cave)" class="btn btn-secondary btn-sm">
          👁️ Détails
        </button>
        <!-- Bouton statistiques -->
        <button (click)="viewCaveStats(cave)" class="btn btn-secondary btn-sm">
          📊 Stats
        </button>
        <!-- Bouton éditer -->
        <button (click)="editCave(cave)" class="btn btn-primary btn-sm">
          ✏️ Éditer
        </button>
        <!-- Bouton supprimer -->
        <button (click)="deleteCave(cave.id)" class="btn btn-danger btn-sm">
          🗑️ Supprimer
        </button>
      </div>
    </div>

    <!-- Message si aucune cave trouvée -->
    <div *ngIf="filteredCaves.length === 0" class="empty-state">
      <p>🏜️ Aucune cave trouvée. Créez-en une pour commencer !</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="totalPages > 1">
    <!-- Bouton page précédente -->
    <button (click)="previousPage()"
            class="btn btn-secondary"
            [disabled]="currentPage === 1">
      ◀ Précédent
    </button>

    <!-- Info pagination -->
    <div class="page-info">
      Page {{ currentPage }} / {{ totalPages }}
    </div>

    <!-- Boutons de numéros de page -->
    <div class="page-numbers">
      <button *ngFor="let page of [].constructor(totalPages); let i = index"
              (click)="goToPage(i + 1)"
              class="btn btn-sm"
              [class.active]="currentPage === i + 1">
        {{ i + 1 }}
      </button>
    </div>

    <!-- Bouton page suivante -->
    <button (click)="nextPage()"
            class="btn btn-secondary"
            [disabled]="currentPage === totalPages">
      Suivant ▶
    </button>
  </div>

  <!-- Modal de détails cave -->
  <div *ngIf="isDetailModalOpen && selectedCave"
       class="modal-overlay"
       (click)="closeDetailModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- En-tête du modal -->
      <div class="modal-header">
        <h3>🍷 {{ selectedCave.name }}</h3>
        <button (click)="closeDetailModal()" class="close-btn">×</button>
      </div>

      <!-- Corps du modal -->
      <div class="modal-body">
        <!-- Infos principales -->
        <div class="cave-details">
          <!-- Localisation -->
          <div class="detail-row">
            <span class="label">📍 Localisation:</span>
            <span class="value">{{ selectedCave.location }}</span>
          </div>
          <!-- Description -->
          <div class="detail-row">
            <span class="label">📝 Description:</span>
            <span class="value">{{ selectedCave.description }}</span>
          </div>
          <!-- Capacité -->
          <div class="detail-row">
            <span class="label">📦 Capacité:</span>
            <span class="value">{{ selectedCave.capacity }} bouteilles</span>
          </div>
          <!-- Bouteilles actuelles -->
          <div class="detail-row">
            <span class="label">🍾 Bouteilles actuelles:</span>
            <span class="value">{{ selectedCave.bottles }}</span>
          </div>
          <!-- Managers -->
          <div class="detail-row">
            <span class="label">👥 Managers:</span>
            <span class="value">{{ selectedCave.managersCount }}</span>
          </div>
          <!-- Employés -->
          <div class="detail-row">
            <span class="label">👨‍💼 Employés:</span>
            <span class="value">{{ selectedCave.employeesCount }}</span>
          </div>
          <!-- Productivité -->
          <div class="detail-row">
            <span class="label">📈 Productivité:</span>
            <span class="value" [ngClass]="'value-' + getProductivityLevel(selectedCave.productivity)">
              {{ selectedCave.productivity }}%
            </span>
          </div>
          <!-- Date de création -->
          <div class="detail-row">
            <span class="label">📅 Date de création:</span>
            <span class="value">{{ selectedCave.createdDate | date: 'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal d'édition cave -->
  <div *ngIf="isEditModalOpen && selectedCave"
       class="modal-overlay"
       (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- En-tête du modal -->
      <div class="modal-header">
        <h3>✏️ Modifier {{ selectedCave.name }}</h3>
        <button (click)="closeEditModal()" class="close-btn">×</button>
      </div>

      <!-- Formulaire d'édition -->
      <div class="modal-body">
        <form (ngSubmit)="saveCaveChanges()" class="edit-form">
          <!-- Champ Nom -->
          <div class="form-group">
            <label class="form-label">Nom de la cave</label>
            <input type="text"
                   class="form-input"
                   [(ngModel)]="selectedCave.name"
                   name="name"
                   required>
          </div>

          <!-- Champ Localisation -->
          <div class="form-group">
            <label class="form-label">Localisation</label>
            <input type="text"
                   class="form-input"
                   [(ngModel)]="selectedCave.location"
                   name="location"
                   required>
          </div>

          <!-- Champ Capacité -->
          <div class="form-group">
            <label class="form-label">Capacité (bouteilles)</label>
            <input type="number"
                   class="form-input"
                   [(ngModel)]="selectedCave.capacity"
                   name="capacity"
                   min="1"
                   required>
          </div>

          <!-- Champ Description -->
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea"
                      [(ngModel)]="selectedCave.description"
                      name="description"
                      rows="4"
                      required></textarea>
          </div>

          <!-- Boutons -->
          <div class="form-actions">
            <button type="button" (click)="closeEditModal()" class="btn btn-secondary">
              ✕ Annuler
            </button>
            <button type="submit" class="btn btn-primary">
              💾 Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
