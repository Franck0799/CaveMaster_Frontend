<!-- ===== PAGE MES MANAGERS ===== -->
<div class="page-section">

  <section class="content-section">

    <!-- ===== En-tÃªte avec titre et bouton d'ajout ===== -->
    <div class="section-header">
      <h2 class="section-title-main">ğŸ‘¥ Mes Managers</h2>
      <button class="btn btn-primary" (click)="openAddManagerModal()">
        â• Ajouter un manager
      </button>
    </div>

    <!-- ===== Statistiques globales ===== -->
    <div class="managers-stats-grid">

      <!-- Total Managers -->
      <div class="stat-card stat-card-blue">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
          <div class="stat-label">Total Managers</div>
          <div class="stat-value">{{ getTotalManagersCount() }}</div>
          <div class="stat-change positive">+2 ce mois</div>
        </div>
      </div>

      <!-- Managers PrÃ©sents -->
      <div class="stat-card stat-card-green">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
          <div class="stat-label">PrÃ©sents Aujourd'hui</div>
          <div class="stat-value">{{ getPresentManagersCount() }}</div>
          <div class="stat-change positive">En service</div>
        </div>
      </div>

      <!-- Managers Absents -->
      <div class="stat-card stat-card-red">
        <div class="stat-icon">âŒ</div>
        <div class="stat-content">
          <div class="stat-label">Absents</div>
          <div class="stat-value">{{ getAbsentManagersCount() }}</div>
          <div class="stat-change negative">Aujourd'hui</div>
        </div>
      </div>

      <!-- En CongÃ© -->
      <div class="stat-card stat-card-orange">
        <div class="stat-icon">ğŸ–ï¸</div>
        <div class="stat-content">
          <div class="stat-label">En CongÃ©</div>
          <div class="stat-value">{{ getOnLeaveManagersCount() }}</div>
          <div class="stat-change neutral">Actuellement</div>
        </div>
      </div>
    </div>

    <!-- ===== Liste des managers ===== -->
    <div class="managers-grid">

      <!-- Boucle sur tous les managers -->
      <div *ngFor="let manager of getAllManagers()" class="manager-card-full">

        <!-- En-tÃªte de la carte manager -->
        <div class="manager-header">
          <div class="manager-avatar-large">{{ manager.avatar }}</div>

          <div class="manager-info-full">
            <div class="manager-name-large">{{ manager.name }}</div>
            <div class="manager-role-large">{{ manager.role }}</div>

            <!-- Badge de disponibilitÃ© -->
            <div class="availability-badge" [ngClass]="getStatusClass(manager.availability.status)">
              <span class="status-icon">{{ getStatusIcon(manager.availability.status) }}</span>
              <span class="status-text">{{ manager.availability.status | titlecase }}</span>
            </div>
          </div>
        </div>

        <!-- Heures d'arrivÃ©e/dÃ©part (si prÃ©sent) -->
        <div class="manager-schedule" *ngIf="manager.availability.status === 'prÃ©sent'">
          <div class="schedule-item">
            <span class="schedule-label">ArrivÃ©e:</span>
            <span class="schedule-time">ğŸ• {{ manager.availability.heureArrivee }}</span>
          </div>
          <div class="schedule-item" *ngIf="manager.availability.heureDepart">
            <span class="schedule-label">DÃ©part:</span>
            <span class="schedule-time">ğŸ•” {{ manager.availability.heureDepart }}</span>
          </div>
        </div>

        <!-- Indicateurs de performance -->
        <div class="manager-performance-full">

          <div class="performance-item">
            <div class="performance-icon">ğŸ’°</div>
            <div class="performance-value">{{ manager.performance.ventes }}</div>
            <div class="performance-label">Ventes totales</div>
          </div>

          <div class="performance-item">
            <div class="performance-icon">ğŸ‘¥</div>
            <div class="performance-value">{{ manager.performance.equipe }}</div>
            <div class="performance-label">Ã‰quipe</div>
          </div>

          <div class="performance-item">
            <div class="performance-icon">â­</div>
            <div class="performance-value">{{ manager.performance.satisfaction }}</div>
            <div class="performance-label">Satisfaction</div>
          </div>
        </div>

        <!-- Bouton pour afficher/masquer les employÃ©s -->
        <button class="toggle-employees" (click)="toggleEmployees(manager)">
          ğŸ‘¥ EmployÃ©s ({{ manager.employees.length }})
          <span>{{ manager.showEmployees ? 'â–²' : 'â–¼' }}</span>
        </button>

        <!-- Liste des employÃ©s (affichÃ©e conditionnellement) -->
        <div *ngIf="manager.showEmployees" class="employees-list-full">

          <div *ngFor="let employee of manager.employees" class="employee-card-full">
            <div class="employee-avatar">{{ employee.avatar }}</div>

            <div class="employee-info">
              <div class="employee-name">{{ employee.name }}</div>
              <div class="employee-position">{{ employee.position }}</div>
            </div>

            <div class="employee-stats">
              <span class="employee-stat">ğŸ’° {{ employee.ventes }}</span>
              <span class="employee-stat">â±ï¸ {{ employee.heures }}</span>
            </div>
          </div>

          <div *ngIf="manager.employees.length === 0" class="empty-employees">
            <p>Aucun employÃ© assignÃ© Ã  ce manager</p>
          </div>
        </div>

        <!-- Actions sur le manager -->
        <div class="manager-actions">
          <!-- Voir profil complet -->
          <button class="btn btn-sm btn-info" (click)="viewManagerStats(manager)">
            ğŸ‘ï¸ Voir profil
          </button>

          <!-- Voir historique -->
          <button class="btn btn-sm btn-secondary" (click)="viewAvailabilityHistory(manager)">
            ğŸ“Š Historique
          </button>

          <!-- Modifier -->
          <button class="btn btn-sm btn-edit" (click)="editManager(manager)">
            âœï¸ Modifier
          </button>

          <!-- Supprimer -->
          <button class="btn btn-sm btn-danger" (click)="deleteManager(manager)">
            ğŸ—‘ï¸ Supprimer
          </button>
        </div>
      </div>

      <!-- Ã‰tat vide si aucun manager -->
      <div *ngIf="getAllManagers().length === 0" class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <p>Aucun manager pour le moment</p>
        <button class="btn btn-primary" (click)="openAddManagerModal()">
          Ajouter le premier manager
        </button>
      </div>
    </div>
  </section>
</div>

<!-- ===== MODAL AJOUTER MANAGER ===== -->
<div *ngIf="isAddManagerModalOpen" class="modal" (click)="closeAddManagerModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">â• Ajouter un nouveau manager</h2>
      <button class="close-btn" (click)="closeAddManagerModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <form>
        <div class="form-group">
          <label class="form-label">PrÃ©nom *</label>
          <input type="text" class="form-input" [(ngModel)]="newManagerForm.firstName"
                 name="firstName" placeholder="Ex: Jean" required>
        </div>

        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input type="text" class="form-input" [(ngModel)]="newManagerForm.lastName"
                 name="lastName" placeholder="Ex: Kouassi" required>
        </div>

        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" class="form-input" [(ngModel)]="newManagerForm.email"
                 name="email" placeholder="Ex: jean.kouassi@caveviking.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">TÃ©lÃ©phone</label>
          <input type="tel" class="form-input" [(ngModel)]="newManagerForm.phone"
                 name="phone" placeholder="Ex: +234 801 234 5678">
        </div>

        <div class="form-group">
          <label class="form-label">Cave d'affectation *</label>
          <select class="form-input" [(ngModel)]="newManagerForm.caveId" name="caveId" required>
            <option value="">SÃ©lectionner une cave...</option>
            <option *ngFor="let cave of caves" [value]="cave.id">{{ cave.name }}</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">RÃ´le *</label>
          <select class="form-input" [(ngModel)]="newManagerForm.role" name="role" required>
            <option value="Manager">Manager</option>
            <option value="Manager Principal">Manager Principal</option>
            <option value="Manager Adjoint">Manager Adjoint</option>
            <option value="Manager Nuit">Manager Nuit</option>
          </select>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeAddManagerModal()">Annuler</button>
      <button class="btn btn-primary" (click)="addNewManager()">Ajouter le manager</button>
    </div>
  </div>
</div>

<!-- ===== MODAL VOIR PROFIL COMPLET ===== -->
<div *ngIf="isViewDetailsModalOpen && selectedManager" class="modal" (click)="closeDetailsModal()">
  <div class="modal-content modal-content-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ‘¤ Profil de {{ selectedManager.name }}</h2>
      <button class="close-btn" (click)="closeDetailsModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <!-- RÃ©sumÃ© du profil -->
      <div class="profile-summary">
        <div class="profile-avatar-large">{{ selectedManager.avatar }}</div>
        <div class="profile-info">
          <h3>{{ selectedManager.name }}</h3>
          <p class="profile-position">{{ selectedManager.role }}</p>
          <div class="availability-badge-large" [ngClass]="getStatusClass(selectedManager.availability.status)">
            {{ getStatusIcon(selectedManager.availability.status) }}
            {{ selectedManager.availability.status | titlecase }}
          </div>
        </div>
      </div>

      <!-- Informations personnelles -->
      <div class="info-section">
        <h4 class="section-subtitle">ğŸ“‹ Informations Personnelles</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Email:</span>
            <span class="info-value">{{ selectedManager.email }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">TÃ©lÃ©phone:</span>
            <span class="info-value">{{ selectedManager.phone }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">RÃ´le:</span>
            <span class="info-value">{{ selectedManager.role }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Cave:</span>
            <span class="info-value">{{ selectedManager.caveId || 'Non assignÃ©e' }}</span>
          </div>
        </div>
      </div>

      <!-- DisponibilitÃ© actuelle -->
      <div class="info-section">
        <h4 class="section-subtitle">â° DisponibilitÃ© Actuelle</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Statut:</span>
            <span class="info-value" [ngClass]="getStatusClass(selectedManager.availability.status)">
              {{ selectedManager.availability.status | titlecase }}
            </span>
          </div>
          <div class="info-item" *ngIf="selectedManager.availability.heureArrivee">
            <span class="info-label">Heure d'arrivÃ©e:</span>
            <span class="info-value">{{ selectedManager.availability.heureArrivee }}</span>
          </div>
          <div class="info-item" *ngIf="selectedManager.availability.heureDepart">
            <span class="info-label">Heure de dÃ©part:</span>
            <span class="info-value">{{ selectedManager.availability.heureDepart }}</span>
          </div>
        </div>
      </div>

      <!-- Performance -->
      <div class="info-section">
        <h4 class="section-subtitle">ğŸ“Š Performance</h4>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Ventes totales:</span>
            <span class="info-value">{{ selectedManager.performance.ventes }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Taille de l'Ã©quipe:</span>
            <span class="info-value">{{ selectedManager.performance.equipe }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Satisfaction:</span>
            <span class="info-value">{{ selectedManager.performance.satisfaction }}</span>
          </div>
        </div>
      </div>

      <!-- Ã‰quipe -->
      <div class="info-section" *ngIf="selectedManager.employees.length > 0">
        <h4 class="section-subtitle">ğŸ‘¥ Ã‰quipe SupervisÃ©e ({{ selectedManager.employees.length }})</h4>
        <div class="team-list">
          <div *ngFor="let employee of selectedManager.employees" class="team-member">
            <span class="member-avatar">{{ employee.avatar }}</span>
            <div class="member-info">
              <span class="member-name">{{ employee.name }}</span>
              <span class="member-position">{{ employee.position }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="viewAvailabilityHistory(selectedManager)">
        ğŸ“Š Voir l'historique
      </button>
      <button class="btn btn-primary" (click)="editManager(selectedManager); closeDetailsModal()">
        âœï¸ Modifier le profil
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL MODIFIER MANAGER ===== -->
<div *ngIf="isEditManagerModalOpen && editManagerForm" class="modal" (click)="closeEditManagerModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">âœï¸ Modifier le manager</h2>
      <button class="close-btn" (click)="closeEditManagerModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <form>
        <div class="form-group">
          <label class="form-label">PrÃ©nom *</label>
          <input type="text" class="form-input" [(ngModel)]="editManagerForm.firstName"
                 name="firstName" required>
        </div>

        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input type="text" class="form-input" [(ngModel)]="editManagerForm.lastName"
                 name="lastName" required>
        </div>

        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" class="form-input" [(ngModel)]="editManagerForm.email"
                 name="email" required>
        </div>

        <div class="form-group">
          <label class="form-label">TÃ©lÃ©phone</label>
          <input type="tel" class="form-input" [(ngModel)]="editManagerForm.phone"
                 name="phone">
        </div>

        <div class="form-group">
          <label class="form-label">RÃ´le *</label>
          <select class="form-input" [(ngModel)]="editManagerForm.role" name="role" required>
            <option value="Manager">Manager</option>
            <option value="Manager Principal">Manager Principal</option>
            <option value="Manager Adjoint">Manager Adjoint</option>
            <option value="Manager Nuit">Manager Nuit</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Statut de disponibilitÃ©</label>
          <select class="form-input" [(ngModel)]="editManagerForm.availability.status" name="status">
            <option value="prÃ©sent">âœ… PrÃ©sent</option>
            <option value="absent">âŒ Absent</option>
            <option value="congÃ©">ğŸ–ï¸ En CongÃ©</option>
          </select>
        </div>

        <div class="form-group" *ngIf="editManagerForm.availability.status === 'prÃ©sent'">
          <label class="form-label">Heure d'arrivÃ©e</label>
          <input type="time" class="form-input" [(ngModel)]="editManagerForm.availability.heureArrivee"
                 name="heureArrivee">
        </div>

        <div class="form-group" *ngIf="editManagerForm.availability.status === 'prÃ©sent'">
          <label class="form-label">Heure de dÃ©part</label>
          <input type="time" class="form-input" [(ngModel)]="editManagerForm.availability.heureDepart"
                 name="heureDepart">
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" (click)="closeEditManagerModal()">Annuler</button>
      <button class="btn btn-primary" (click)="saveManagerChanges()">
        ğŸ’¾ Enregistrer les modifications
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL HISTORIQUE DE DISPONIBILITÃ‰ ===== -->
<div *ngIf="isViewHistoryModalOpen && selectedManager" class="modal" (click)="closeHistoryModal()">
  <div class="modal-content modal-content-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“Š Historique de {{ selectedManager.name }}</h2>
      <button class="close-btn" (click)="closeHistoryModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <!-- Statistiques rÃ©sumÃ©es -->
      <div class="history-stats">
        <div class="history-stat-card">
          <div class="stat-icon-small">âœ…</div>
          <div class="stat-content-small">
            <div class="stat-value-small">
              {{ getHistoryPresentDays(selectedManager) }}
            </div>
            <div class="stat-label-small">Jours prÃ©sents</div>
          </div>
        </div>

        <div class="history-stat-card">
          <div class="stat-icon-small">âŒ</div>
          <div class="stat-content-small">
            <div class="stat-value-small">
              {{ getHistoryAbsentDays(selectedManager) }}
            </div>
            <div class="stat-label-small">Jours absents</div>
          </div>
        </div>

        <div class="history-stat-card">
          <div class="stat-icon-small">ğŸ–ï¸</div>
          <div class="stat-content-small">
            <div class="stat-value-small">
             {{ getHistoryLeaveDays(selectedManager) }}
            </div>
            <div class="stat-label-small">Jours de congÃ©</div>
          </div>
        </div>
      </div>

      <!-- Tableau d'historique -->
      <div class="history-table">
        <div class="history-table-header">
          <h4>Historique des 30 derniers jours</h4>
        </div>

        <div class="history-table-content">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Statut</th>
                <th>ArrivÃ©e</th>
                <th>DÃ©part</th>
                <th>DurÃ©e</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let record of selectedManager.availabilityHistory"
                  [ngClass]="'row-' + record.status">
                <td class="date-cell">{{ record.date }}</td>
                <td>
                  <span class="status-badge-small" [ngClass]="getStatusClass(record.status)">
                    {{ getStatusIcon(record.status) }} {{ record.status | titlecase }}
                  </span>
                </td>
                <td class="time-cell">{{ record.heureArrivee || '-' }}</td>
                <td class="time-cell">{{ record.heureDepart || '-' }}</td>
                <td class="duration-cell">{{ record.duree || '-' }}</td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="selectedManager.availabilityHistory.length === 0" class="empty-history">
            <p>Aucun historique disponible pour ce manager</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeHistoryModal()">Fermer</button>
      <button class="btn btn-primary" (click)="closeHistoryModal(); editManager(selectedManager)">
        âœï¸ Modifier le profil
      </button>
    </div>
  </div>
</div>
