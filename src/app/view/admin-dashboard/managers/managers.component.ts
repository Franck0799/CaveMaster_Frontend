import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';

/**
 * Interface pour l'historique de disponibilit√©
 */
interface AvailabilityHistory {
  date: string;
  status: 'pr√©sent' | 'absent' | 'cong√©';
  heureArrivee?: string;
  heureDepart?: string;
  duree?: string;
}

/**
 * Interface pour la disponibilit√© actuelle
 */
interface Availability {
  status: 'pr√©sent' | 'absent' | 'cong√©';
  heureArrivee?: string;
  heureDepart?: string;
  lastUpdate: string;
}

/**
 * Interface pour un employ√© rattach√© √† un manager
 */
interface Employee {
  id: string;
  avatar: string;
  name: string;
  position: string;
  ventes: string;
  heures: string;
}

/**
 * Interface pour d√©finir la structure d'un manager
 */
interface Manager {
  id: string;
  avatar: string;
  name: string;
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  role: string;
  performance: {
    ventes: string;
    equipe: string;
    satisfaction: string;
  };
  employees: Employee[];
  showEmployees?: boolean;
  caveId?: string;
  availability: Availability;
  availabilityHistory: AvailabilityHistory[];
}

/**
 * Interface pour le formulaire d'ajout de manager
 */
interface NewManagerForm {
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  caveId: string;
  role: string;
}

@Component({
  selector: 'app-managers',
  standalone: true,
  imports: [CommonModule, FormsModule, ReactiveFormsModule],
  templateUrl: './managers.component.html',
  styleUrls: ['./managers.component.scss']
})
export class ManagersComponent implements OnInit {

  // Liste de tous les managers avec disponibilit√©
  managers: Manager[] = [
    {
      id: '1',
      avatar: 'üë®‚Äçüíº',
      firstName: 'Jean',
      lastName: 'Dupont',
      name: 'Jean Dupont',
      email: 'jean.dupont@drinkstore.com',
      phone: '+234 801 111 2222',
      role: 'Manager Principal',
      performance: {
        ventes: '1.2M FCFA',
        equipe: '8 personnes',
        satisfaction: '4.8/5'
      },
      employees: [
        {
          id: 'emp1',
          avatar: 'üë®',
          name: 'Marc Kouassi',
          position: 'Vendeur',
          ventes: '250K',
          heures: '160h'
        },
        {
          id: 'emp2',
          avatar: 'üë©',
          name: 'Sophie Diallo',
          position: 'Caissi√®re',
          ventes: '180K',
          heures: '155h'
        }
      ],
      showEmployees: false,
      availability: {
        status: 'pr√©sent',
        heureArrivee: '07:45',
        heureDepart: '18:30',
        lastUpdate: '2025-01-27T07:45:00'
      },
      availabilityHistory: [
        { date: '2025-01-27', status: 'pr√©sent', heureArrivee: '07:45', heureDepart: '18:30', duree: '10h45' },
        { date: '2025-01-26', status: 'pr√©sent', heureArrivee: '07:50', heureDepart: '18:00', duree: '10h10' },
        { date: '2025-01-25', status: 'pr√©sent', heureArrivee: '07:40', heureDepart: '18:15', duree: '10h35' },
        { date: '2025-01-24', status: 'absent', heureArrivee: '-', heureDepart: '-', duree: '-' }
      ]
    },
    {
      id: '2',
      avatar: 'üë©‚Äçüíº',
      firstName: 'Marie',
      lastName: 'Martin',
      name: 'Marie Martin',
      email: 'marie.martin@drinkstore.com',
      phone: '+234 802 333 4444',
      role: 'Manager',
      performance: {
        ventes: '980K FCFA',
        equipe: '6 personnes',
        satisfaction: '4.6/5'
      },
      employees: [
        {
          id: 'emp3',
          avatar: 'üë®',
          name: 'Paul Mensah',
          position: 'Magasinier',
          ventes: '150K',
          heures: '165h'
        }
      ],
      showEmployees: false,
      availability: {
        status: 'cong√©',
        lastUpdate: '2025-01-25T00:00:00'
      },
      availabilityHistory: [
        { date: '2025-01-27', status: 'cong√©', heureArrivee: '-', heureDepart: '-', duree: '-' },
        { date: '2025-01-26', status: 'cong√©', heureArrivee: '-', heureDepart: '-', duree: '-' },
        { date: '2025-01-25', status: 'pr√©sent', heureArrivee: '08:00', heureDepart: '17:30', duree: '9h30' },
        { date: '2025-01-24', status: 'pr√©sent', heureArrivee: '08:10', heureDepart: '17:45', duree: '9h35' }
      ]
    }
  ];

  // Modals
  isAddManagerModalOpen: boolean = false;
  isEditManagerModalOpen: boolean = false;
  isViewDetailsModalOpen: boolean = false;
  isViewHistoryModalOpen: boolean = false;

  // Manager s√©lectionn√© pour les modals
  selectedManager: Manager | null = null;

  // Formulaire pour nouveau manager
  newManagerForm: NewManagerForm = {
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    caveId: '',
    role: 'Manager'
  };

  // Formulaire d'√©dition
  editManagerForm: Manager | null = null;

  // Liste des caves
  caves: any[] = [
    { id: 'cave1', name: 'Cave Abidjan Centre' },
    { id: 'cave2', name: 'Cave Cocody' },
    { id: 'cave3', name: 'Cave Yopougon' }
  ];

  constructor() {}

  ngOnInit(): void {
    this.loadManagers();
    this.loadCaves();
  }

  /**
   * Charge la liste des managers depuis le backend
   */
  loadManagers(): void {
    console.log('Chargement des managers...');
  }

  /**
   * Charge la liste des caves
   */
  loadCaves(): void {
    console.log('Chargement des caves...');
  }

  /**
   * Retourne tous les managers
   */
  getAllManagers(): Manager[] {
    return this.managers;
  }

  /**
   * Toggle l'affichage des employ√©s d'un manager
   */
  toggleEmployees(manager: Manager): void {
    manager.showEmployees = !manager.showEmployees;
  }

  /**
   * Calcule le nombre total de managers
   */
  getTotalManagersCount(): number {
    return this.managers.length;
  }

  /**
   * Compte les managers pr√©sents
   */
  getPresentManagersCount(): number {
    return this.managers.filter(m => m.availability.status === 'pr√©sent').length;
  }

  /**
   * Compte les managers absents
   */
  getAbsentManagersCount(): number {
    return this.managers.filter(m => m.availability.status === 'absent').length;
  }

  /**
   * Compte les managers en cong√©
   */
  getOnLeaveManagersCount(): number {
    return this.managers.filter(m => m.availability.status === 'cong√©').length;
  }

  /**
   * Calcule le nombre total d'employ√©s supervis√©s
   */
  getTotalEmployeesSupervised(): number {
    return this.managers.reduce((total, manager) => {
      return total + manager.employees.length;
    }, 0);
  }

  /**
   * Calcule les ventes totales de tous les managers
   */
  getTotalSales(): string {
    return '2.18M';
  }

  /**
   * Ouvre le modal d'ajout de manager
   */
  openAddManagerModal(): void {
    this.isAddManagerModalOpen = true;
    this.resetManagerForm();
  }

  /**
   * Ferme le modal d'ajout de manager
   */
  closeAddManagerModal(): void {
    this.isAddManagerModalOpen = false;
  }

  /**
   * R√©initialise le formulaire de manager
   */
  resetManagerForm(): void {
    this.newManagerForm = {
      firstName: '',
      lastName: '',
      email: '',
      phone: '',
      caveId: '',
      role: 'Manager'
    };
  }

  /**
   * Ajoute un nouveau manager
   */
  addNewManager(): void {
    if (!this.validateManagerForm()) {
      alert('Veuillez remplir tous les champs obligatoires');
      return;
    }

    const newManager: Manager = {
      id: this.generateId(),
      avatar: this.getRandomAvatar(),
      firstName: this.newManagerForm.firstName,
      lastName: this.newManagerForm.lastName,
      name: `${this.newManagerForm.firstName} ${this.newManagerForm.lastName}`,
      email: this.newManagerForm.email,
      phone: this.newManagerForm.phone,
      role: this.newManagerForm.role,
      performance: {
        ventes: '0 FCFA',
        equipe: '0 personnes',
        satisfaction: '0/5'
      },
      employees: [],
      showEmployees: false,
      caveId: this.newManagerForm.caveId,
      availability: {
        status: 'absent',
        lastUpdate: new Date().toISOString()
      },
      availabilityHistory: []
    };

    this.managers.push(newManager);
    console.log('Nouveau manager ajout√©:', newManager);
    this.closeAddManagerModal();
    alert('Manager ajout√© avec succ√®s !');
  }

  /**
   * Valide le formulaire de manager
   */
  validateManagerForm(): boolean {
    return !!(
      this.newManagerForm.firstName &&
      this.newManagerForm.lastName &&
      this.newManagerForm.email &&
      this.newManagerForm.caveId &&
      this.newManagerForm.role
    );
  }

  /**
   * G√©n√®re un ID unique
   */
  generateId(): string {
    return `mgr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  /**
   * Retourne un avatar al√©atoire
   */
  getRandomAvatar(): string {
    const avatars = ['üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüè´', 'üë©‚Äçüè´', 'üë®‚Äçüíª', 'üë©‚Äçüíª'];
    return avatars[Math.floor(Math.random() * avatars.length)];
  }

  /**
   * Ouvre le modal d'√©dition avec les informations du manager
   */
  editManager(manager: Manager): void {
    this.selectedManager = manager;
    this.editManagerForm = { ...manager };
    this.isEditManagerModalOpen = true;
  }

  /**
   * Ferme le modal d'√©dition
   */
  closeEditManagerModal(): void {
    this.isEditManagerModalOpen = false;
    this.selectedManager = null;
    this.editManagerForm = null;
  }

  /**
   * Sauvegarde les modifications du manager
   */
  saveManagerChanges(): void {
    if (!this.editManagerForm) return;

    const index = this.managers.findIndex(m => m.id === this.editManagerForm!.id);
    if (index !== -1) {
      this.managers[index] = { ...this.editManagerForm };
      console.log('Manager modifi√©:', this.managers[index]);
      alert('Informations mises √† jour avec succ√®s !');
      this.closeEditManagerModal();
    }
  }

  /**
   * Supprime un manager
   */
  deleteManager(manager: Manager): void {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${manager.name} ?`)) {
      this.managers = this.managers.filter(m => m.id !== manager.id);
      console.log('Manager supprim√©:', manager);
      alert('Manager supprim√© avec succ√®s');
    }
  }

  /**
   * Affiche les statistiques d√©taill√©es d'un manager
   */
  viewManagerStats(manager: Manager): void {
    this.selectedManager = manager;
    this.isViewDetailsModalOpen = true;
  }

  /**
   * Ferme le modal de d√©tails
   */
  closeDetailsModal(): void {
    this.isViewDetailsModalOpen = false;
    this.selectedManager = null;
  }

  /**
   * Affiche l'historique de disponibilit√©
   */
  viewAvailabilityHistory(manager: Manager): void {
    this.selectedManager = manager;
    this.isViewHistoryModalOpen = true;
  }

  /**
   * Ferme le modal d'historique
   */
  closeHistoryModal(): void {
    this.isViewHistoryModalOpen = false;
    this.selectedManager = null;
  }

  /**
   * Retourne la classe CSS selon le statut
   */
  getStatusClass(status: string): string {
    switch(status) {
      case 'pr√©sent': return 'status-present';
      case 'absent': return 'status-absent';
      case 'cong√©': return 'status-leave';
      default: return '';
    }
  }

  /**
   * Retourne l'ic√¥ne selon le statut
   */
  getStatusIcon(status: string): string {
    switch(status) {
      case 'pr√©sent': return '‚úÖ';
      case 'absent': return '‚ùå';
      case 'cong√©': return 'üèñÔ∏è';
      default: return '‚ùì';
    }
  }

  /**
   * Compte les jours pr√©sents dans l'historique
   */
  getHistoryPresentDays(manager: Manager): number {
    return manager.availabilityHistory.filter(h => h.status === 'pr√©sent').length;
  }

  /**
   * Compte les jours absents dans l'historique
   */
  getHistoryAbsentDays(manager: Manager): number {
    return manager.availabilityHistory.filter(h => h.status === 'absent').length;
  }

  /**
   * Compte les jours de cong√© dans l'historique
   */
  getHistoryLeaveDays(manager: Manager): number {
    return manager.availabilityHistory.filter(h => h.status === 'cong√©').length;
  }
}
