<!-- ===== PAGE SCAN ===== -->
<div class="page-section">

  <section class="content-section">

    <!-- En-t√™te de la page -->
    <div class="section-header">
      <h2 class="section-title-main">üì∑ Scanner un Produit</h2>
    </div>

    <!-- Conteneur principal du scan -->
    <div class="scan-container">

      <!-- ===== Zone de scan ===== -->
      <div class="scan-area">

        <!-- Cadre de scan avec animation -->
        <div class="scan-frame" [class.scanning]="isScanActive">

          <!-- Ic√¥ne de cam√©ra -->
          <div class="scan-icon">üì∑</div>

          <!-- Texte d'instruction dynamique -->
          <div class="scan-text">
            <!-- Message initial: avant le scan -->
            <ng-container *ngIf="!isScanActive && !scanResult">
              Placez le code-barre devant la cam√©ra
            </ng-container>

            <!-- Message pendant le scan -->
            <ng-container *ngIf="isScanActive">
              Scan en cours...
            </ng-container>

            <!-- Message apr√®s le scan -->
            <ng-container *ngIf="scanResult && !isScanActive">
              ‚úì Scan termin√©
            </ng-container>
          </div>

          <!-- Ligne de scan anim√©e (affich√©e pendant le scan) -->
          <div *ngIf="isScanActive" class="scan-line"></div>
        </div>

        <!-- ===== Boutons de contr√¥le ===== -->
        <div class="scan-controls">

          <!-- Bouton pour d√©marrer le scan -->
          <button class="btn btn-primary"
                  *ngIf="!isScanActive && !scanResult"
                  (click)="startScan()">
            üé¨ D√©marrer le scan
          </button>

          <!-- Bouton pour arr√™ter le scan en cours -->
          <button class="btn btn-danger"
                  *ngIf="isScanActive"
                  (click)="stopScan()">
            ‚èπÔ∏è Arr√™ter le scan
          </button>

          <!-- Bouton pour faire un nouveau scan -->
          <button class="btn btn-secondary"
                  *ngIf="scanResult"
                  (click)="resetScan()">
            üîÑ Nouveau scan
          </button>
        </div>
      </div>

      <!-- ===== R√©sultat du scan ===== -->
      <div *ngIf="scanResult" class="scan-result">

        <!-- En-t√™te du r√©sultat -->
        <div class="result-header">
          <h3>‚úì Produit d√©tect√©</h3>
        </div>

        <!-- Contenu du r√©sultat (informations format√©es en JSON) -->
        <div class="result-content">
          <pre>{{ getFormattedScanResult() }}</pre>
        </div>

        <!-- Actions disponibles sur le produit scann√© -->
        <div class="result-actions">

          <!-- Bouton: Ajouter au stock -->
          <button class="btn btn-primary" (click)="addToStock()">
            ‚ûï Ajouter au stock
          </button>

          <!-- Bouton: Modifier les infos -->
          <button class="btn btn-secondary" (click)="editProductInfo()">
            üìù Modifier les infos
          </button>

          <!-- Bouton: Voir l'historique -->
          <button class="btn btn-info" (click)="viewProductHistory()">
            üìä Voir l'historique
          </button>
        </div>
      </div>
    </div>

    <!-- ===== Instructions d'utilisation ===== -->
    <div class="scan-instructions">
      <h3>üí° Instructions</h3>

      <ul>
        <!-- Liste des bonnes pratiques pour scanner -->
        <li>Assurez-vous que le code-barre est bien √©clair√©</li>
        <li>Maintenez le code-barre stable et √† plat</li>
        <li>Positionnez-le √† environ 15-20 cm de la cam√©ra</li>
        <li>Attendez le bip de confirmation</li>
      </ul>

      <!-- Note technique -->
      <div class="scan-note">
        <strong>Note:</strong> Ceci est une simulation du scan d'un code-barres,
        avec des donn√©es statiques. A la finalisation une cam√©ra serait utilis√©e pour scanner
        de v√©ritables codes-barres.
      </div>
    </div>
  </section>
</div>

<!-- ===== MODAL DE MODIFICATION ===== -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">

    <!-- En-t√™te du modal -->
    <div class="modal-header">
      <h2>üìù Modifier les informations</h2>
      <button class="modal-close" (click)="closeEditModal()">‚úï</button>
    </div>

    <!-- Corps du modal -->
    <div class="modal-body">
      <form [formGroup]="editForm">

        <!-- Nom du produit -->
        <div class="form-group">
          <label for="productName">Nom du produit *</label>
          <input
            type="text"
            id="productName"
            formControlName="productName"
            class="form-control"
            placeholder="Ex: Ch√¢teau Margaux 2015">
          <div class="form-error" *ngIf="editForm.get('productName')?.invalid && editForm.get('productName')?.touched">
            Le nom du produit est requis (min. 3 caract√®res)
          </div>
        </div>

        <!-- Code-barres -->
        <div class="form-group">
          <label for="barcode">Code-barres *</label>
          <input
            type="text"
            id="barcode"
            formControlName="barcode"
            class="form-control"
            placeholder="Ex: 3256220025508">
          <div class="form-error" *ngIf="editForm.get('barcode')?.invalid && editForm.get('barcode')?.touched">
            Le code-barres est requis
          </div>
        </div>

        <!-- Cat√©gorie -->
        <div class="form-group">
          <label for="category">Cat√©gorie *</label>
          <select
            id="category"
            formControlName="category"
            class="form-control">
            <option value="">-- S√©lectionnez une cat√©gorie --</option>
            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
          </select>
          <div class="form-error" *ngIf="editForm.get('category')?.invalid && editForm.get('category')?.touched">
            La cat√©gorie est requise
          </div>
        </div>

        <!-- Prix -->
        <div class="form-group">
          <label for="price">Prix (FCFA) *</label>
          <input
            type="number"
            id="price"
            formControlName="price"
            class="form-control"
            placeholder="Ex: 450000">
          <div class="form-error" *ngIf="editForm.get('price')?.invalid && editForm.get('price')?.touched">
            Le prix est requis et doit √™tre positif
          </div>
        </div>

        <!-- Stock -->
        <div class="form-group">
          <label for="stock">Stock disponible *</label>
          <input
            type="number"
            id="stock"
            formControlName="stock"
            class="form-control"
            placeholder="Ex: 12">
          <div class="form-error" *ngIf="editForm.get('stock')?.invalid && editForm.get('stock')?.touched">
            Le stock est requis et doit √™tre positif
          </div>
        </div>

      </form>
    </div>

    <!-- Pied du modal -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEditModal()">
        Annuler
      </button>
      <button
        class="btn btn-primary"
        [disabled]="editForm.invalid"
        (click)="saveProductEdits()">
        üíæ Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL D'AJOUT AU STOCK ===== -->
<div class="modal-overlay" *ngIf="showStockModal" (click)="closeStockModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">

    <!-- En-t√™te du modal -->
    <div class="modal-header">
      <h2>‚ûï Ajouter au stock</h2>
      <button class="modal-close" (click)="closeStockModal()">‚úï</button>
    </div>

    <!-- Corps du modal -->
    <div class="modal-body">

      <!-- Infos du produit -->
      <div class="product-info-box" *ngIf="scanResult">
        <strong>{{ scanResult.productName }}</strong>
        <p>Stock actuel: {{ scanResult.stock }} unit√©s</p>
      </div>

      <form [formGroup]="stockForm">

        <!-- Quantit√© √† ajouter -->
        <div class="form-group">
          <label for="quantity">Quantit√© √† ajouter *</label>
          <input
            type="number"
            id="quantity"
            formControlName="quantity"
            class="form-control"
            placeholder="Ex: 10"
            min="1">
          <div class="form-error" *ngIf="stockForm.get('quantity')?.invalid && stockForm.get('quantity')?.touched">
            La quantit√© doit √™tre au moins 1
          </div>
        </div>

        <!-- Notes (optionnel) -->
        <div class="form-group">
          <label for="notes">Notes (optionnel)</label>
          <textarea
            id="notes"
            formControlName="notes"
            class="form-control"
            rows="3"
            placeholder="Ex: Livraison du 29/10/2025"></textarea>
        </div>

      </form>

      <!-- Aper√ßu du nouveau stock -->
      <div class="stock-preview" *ngIf="scanResult && stockForm.get('quantity')?.value">
        <strong>Nouveau stock:</strong>
        {{ scanResult.stock + stockForm.get('quantity')?.value }} unit√©s
        <span class="stock-increase">
          (+{{ stockForm.get('quantity')?.value }})
        </span>
      </div>
    </div>

    <!-- Pied du modal -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeStockModal()">
        Annuler
      </button>
      <button
        class="btn btn-primary"
        [disabled]="stockForm.invalid"
        (click)="confirmAddToStock()">
        ‚úì Confirmer
      </button>
    </div>
  </div>
</div>

<!-- ===== MODAL D'HISTORIQUE ===== -->
<div class="modal-overlay" *ngIf="showHistoryModal" (click)="closeHistoryModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">

    <!-- En-t√™te du modal -->
    <div class="modal-header">
      <h2>üìä Historique des scans</h2>
      <button class="modal-close" (click)="closeHistoryModal()">‚úï</button>
    </div>

    <!-- Corps du modal -->
    <div class="modal-body">

      <!-- Aucun historique -->
      <div *ngIf="scanHistory.length === 0" class="empty-state">
        <div class="empty-icon">üì≠</div>
        <p>Aucun scan dans l'historique</p>
      </div>

      <!-- Liste de l'historique -->
      <div *ngIf="scanHistory.length > 0" class="history-list">

        <!-- Bouton pour effacer l'historique -->
        <div class="history-actions">
          <button class="btn btn-danger btn-sm" (click)="clearHistory()">
            üóëÔ∏è Effacer l'historique
          </button>
          <span class="history-count">{{ scanHistory.length }} scan(s)</span>
        </div>

        <!-- Items d'historique -->
        <div *ngFor="let item of scanHistory" class="history-item">

          <!-- Ic√¥ne et action -->
          <div class="history-icon">
            {{ getActionIcon(item.action) }}
          </div>

          <!-- D√©tails -->
          <div class="history-details">
            <h4>{{ item.scanResult.productName }}</h4>
            <p class="history-meta">
              <span class="history-category">{{ item.scanResult.category }}</span>
              <span class="history-barcode">{{ item.scanResult.barcode }}</span>
            </p>
            <p class="history-info">
              <span>{{ formatPrice(item.scanResult.price) }} FCFA</span>
              <span>‚Ä¢</span>
              <span>Stock: {{ item.scanResult.stock }} unit√©s</span>
            </p>
          </div>

          <!-- Action et date -->
          <div class="history-action">
            <span class="action-badge" [class]="'action-' + item.action">
              {{ getActionLabel(item.action) }}
            </span>
            <span class="history-date">
              {{ formatDate(item.actionDate) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Pied du modal -->
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="closeHistoryModal()">
        Fermer
      </button>
    </div>
  </div>
</div>
