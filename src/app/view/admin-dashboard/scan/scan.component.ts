import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';

/**
 * Interface pour le r√©sultat du scan
 */
interface ScanResult {
  barcode: string;
  productName: string;
  category: string;
  price: number;
  stock: number;
  timestamp: Date;
}

/**
 * Interface pour l'historique des scans
 */
interface ScanHistory {
  id: string;
  scanResult: ScanResult;
  action: 'added' | 'modified' | 'viewed';
  actionDate: Date;
}

/**
 * Composant Scan - Scanner de code-barres
 * Permet de scanner des produits et d'obtenir leurs informations
 */
@Component({
  selector: 'app-scan',
  standalone: true,
  imports: [CommonModule, FormsModule, ReactiveFormsModule],
  templateUrl: './scan.component.html',
  styleUrls: ['./scan.component.scss']
})
export class ScanComponent implements OnInit, OnDestroy {

  // √âtat du scan
  isScanActive: boolean = false;

  // R√©sultat du scan
  scanResult: ScanResult | null = null;

  // Timer pour simulation du scan
  private scanTimer: any = null;

  // Gestion du modal de modification
  showEditModal: boolean = false;
  editForm!: FormGroup;

  // Gestion du modal d'ajout au stock
  showStockModal: boolean = false;
  stockForm!: FormGroup;

  // Gestion du modal d'historique
  showHistoryModal: boolean = false;
  scanHistory: ScanHistory[] = [];

  // Liste des cat√©gories disponibles
  categories: string[] = [
    'Vin Rouge',
    'Vin Blanc',
    'Vin Ros√©',
    'Champagne',
    'Bi√®re',
    'Liqueur',
    'Whisky',
    'Vodka',
    'Rhum',
    'Cognac',
    'Gin',
    'Tequila',
    'Cocktails',
    'Soft Drinks',
    'Eau',
    'Jus'
  ];

  constructor(private fb: FormBuilder) {
    this.initForms();
  }

  ngOnInit(): void {
    console.log('Composant Scan initialis√©');
    this.loadScanHistory();
  }

  ngOnDestroy(): void {
    this.stopScan();
  }

  /**
   * Initialise les formulaires
   */
  private initForms(): void {
    // Formulaire de modification
    this.editForm = this.fb.group({
      productName: ['', [Validators.required, Validators.minLength(3)]],
      category: ['', Validators.required],
      price: [0, [Validators.required, Validators.min(0)]],
      stock: [0, [Validators.required, Validators.min(0)]],
      barcode: ['', Validators.required]
    });

    // Formulaire d'ajout au stock
    this.stockForm = this.fb.group({
      quantity: [1, [Validators.required, Validators.min(1)]],
      notes: ['']
    });
  }

  /**
   * Charge l'historique depuis localStorage
   */
  private loadScanHistory(): void {
    const stored = localStorage.getItem('scanHistory');
    if (stored) {
      this.scanHistory = JSON.parse(stored).map((item: any) => ({
        ...item,
        scanResult: {
          ...item.scanResult,
          timestamp: new Date(item.scanResult.timestamp)
        },
        actionDate: new Date(item.actionDate)
      }));
    }
  }

  /**
   * Sauvegarde l'historique dans localStorage
   */
  private saveScanHistory(): void {
    localStorage.setItem('scanHistory', JSON.stringify(this.scanHistory));
  }

  /**
   * Ajoute une entr√©e √† l'historique
   */
  private addToHistory(action: 'added' | 'modified' | 'viewed'): void {
    if (!this.scanResult) return;

    const historyItem: ScanHistory = {
      id: `scan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      scanResult: { ...this.scanResult },
      action,
      actionDate: new Date()
    };

    this.scanHistory.unshift(historyItem);

    // Limite l'historique √† 50 entr√©es
    if (this.scanHistory.length > 50) {
      this.scanHistory = this.scanHistory.slice(0, 50);
    }

    this.saveScanHistory();
  }

  /**
   * D√©marre le processus de scan
   */
  startScan(): void {
    this.isScanActive = true;
    this.scanResult = null;
    console.log('Scan d√©marr√©...');

    this.scanTimer = setTimeout(() => {
      this.completeScan();
    }, 3000);
  }

  /**
   * Arr√™te le processus de scan
   */
  stopScan(): void {
    this.isScanActive = false;

    if (this.scanTimer) {
      clearTimeout(this.scanTimer);
      this.scanTimer = null;
    }

    console.log('Scan arr√™t√©');
  }

  /**
   * Compl√®te le scan et g√©n√®re un r√©sultat
   */
  private completeScan(): void {
    this.isScanActive = false;
    this.scanResult = this.generateMockScanResult();
    console.log('Scan termin√©:', this.scanResult);
    this.playBeepSound();
  }

  /**
   * G√©n√®re un r√©sultat de scan simul√© pour la d√©mo
   */
  private generateMockScanResult(): ScanResult {
    const mockProducts = [
      {
        barcode: '3256220025508',
        productName: 'Ch√¢teau Margaux 2015',
        category: 'Vin Rouge',
        price: 450000,
        stock: 12
      },
      {
        barcode: '3161780254897',
        productName: 'Champagne Mo√´t & Chandon',
        category: 'Champagne',
        price: 85000,
        stock: 25
      },
      {
        barcode: '5449000000996',
        productName: 'Heineken 33cl',
        category: 'Bi√®re',
        price: 1500,
        stock: 150
      },
      {
        barcode: '8712000043094',
        productName: 'Martini Rosso',
        category: 'Liqueur',
        price: 8500,
        stock: 30
      }
    ];

    const randomProduct = mockProducts[Math.floor(Math.random() * mockProducts.length)];

    return {
      ...randomProduct,
      timestamp: new Date()
    };
  }

  /**
   * R√©initialise le scan pour un nouveau scan
   */
  resetScan(): void {
    this.scanResult = null;
    this.isScanActive = false;
    console.log('Scan r√©initialis√©');
  }

  /**
   * Formate le r√©sultat du scan en JSON lisible
   */
  getFormattedScanResult(): string {
    if (!this.scanResult) return '';

    return JSON.stringify({
      'Code-barres': this.scanResult.barcode,
      'Nom du produit': this.scanResult.productName,
      'Cat√©gorie': this.scanResult.category,
      'Prix': `${this.formatPrice(this.scanResult.price)} FCFA`,
      'Stock disponible': `${this.scanResult.stock} unit√©s`,
      'Date du scan': this.formatDate(this.scanResult.timestamp)
    }, null, 2);
  }

  /**
   * Formate un prix en ajoutant des s√©parateurs de milliers
   */
  formatPrice(price: number): string {
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }

  /**
   * Formate une date en format lisible
   */
  formatDate(date: Date): string {
    return date.toLocaleString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  /**
   * Joue un son de confirmation (bip)
   */
  private playBeepSound(): void {
    console.log('üîä Bip!');
  }

  // ===== MODAL DE MODIFICATION =====

  /**
   * Ouvre le modal de modification
   */
  editProductInfo(): void {
    if (!this.scanResult) return;

    // Pr√©-remplit le formulaire avec les donn√©es actuelles
    this.editForm.patchValue({
      productName: this.scanResult.productName,
      category: this.scanResult.category,
      price: this.scanResult.price,
      stock: this.scanResult.stock,
      barcode: this.scanResult.barcode
    });

    this.showEditModal = true;
  }

  /**
   * Ferme le modal de modification
   */
  closeEditModal(): void {
    this.showEditModal = false;
    this.editForm.reset();
  }

  /**
   * Sauvegarde les modifications
   */
  saveProductEdits(): void {
    if (this.editForm.invalid || !this.scanResult) return;

    const formValue = this.editForm.value;

    // Met √† jour le r√©sultat du scan
    this.scanResult = {
      ...this.scanResult,
      productName: formValue.productName,
      category: formValue.category,
      price: formValue.price,
      stock: formValue.stock,
      barcode: formValue.barcode
    };

    // Ajoute √† l'historique
    this.addToHistory('modified');

    console.log('Produit modifi√©:', this.scanResult);

    // Ferme le modal
    this.closeEditModal();

    // TODO: Appel API pour sauvegarder en base de donn√©es
    alert('Modifications enregistr√©es avec succ√®s !');
  }

  // ===== MODAL D'AJOUT AU STOCK =====

  /**
   * Ouvre le modal d'ajout au stock
   */
  addToStock(): void {
    if (!this.scanResult) return;

    this.stockForm.patchValue({
      quantity: 1,
      notes: ''
    });

    this.showStockModal = true;
  }

  /**
   * Ferme le modal d'ajout au stock
   */
  closeStockModal(): void {
    this.showStockModal = false;
    this.stockForm.reset();
  }

  /**
   * Confirme l'ajout au stock
   */
  confirmAddToStock(): void {
    if (this.stockForm.invalid || !this.scanResult) return;

    const quantity = this.stockForm.value.quantity;
    const notes = this.stockForm.value.notes;

    // Met √† jour le stock
    this.scanResult.stock += quantity;

    // Ajoute √† l'historique
    this.addToHistory('added');

    console.log(`Ajout de ${quantity} unit√©(s) au stock. Notes:`, notes);

    // Ferme le modal
    this.closeStockModal();

    // TODO: Appel API pour mettre √† jour le stock en base de donn√©es
    alert(`${quantity} unit√©(s) de "${this.scanResult.productName}" ajout√©e(s) au stock avec succ√®s !`);

    // R√©initialise pour un nouveau scan
    this.resetScan();
  }

  // ===== MODAL D'HISTORIQUE =====

  /**
   * Ouvre le modal d'historique
   */
  viewProductHistory(): void {
    this.showHistoryModal = true;
  }

  /**
   * Ferme le modal d'historique
   */
  closeHistoryModal(): void {
    this.showHistoryModal = false;
  }

  /**
   * Retourne l'ic√¥ne selon le type d'action
   */
  getActionIcon(action: string): string {
    switch (action) {
      case 'added': return '‚ûï';
      case 'modified': return 'üìù';
      case 'viewed': return 'üëÅÔ∏è';
      default: return 'üìä';
    }
  }

  /**
   * Retourne le libell√© de l'action
   */
  getActionLabel(action: string): string {
    switch (action) {
      case 'added': return 'Ajout√© au stock';
      case 'modified': return 'Modifi√©';
      case 'viewed': return 'Consult√©';
      default: return 'Action inconnue';
    }
  }

  /**
   * Efface l'historique
   */
  clearHistory(): void {
    if (confirm('√ätes-vous s√ªr de vouloir effacer tout l\'historique ?')) {
      this.scanHistory = [];
      this.saveScanHistory();
      alert('Historique effac√© avec succ√®s !');
    }
  }

  /**
   * Filtre l'historique par produit actuel
   */
  getCurrentProductHistory(): ScanHistory[] {
    if (!this.scanResult) return this.scanHistory;

    return this.scanHistory.filter(
      item => item.scanResult.barcode === this.scanResult!.barcode
    );
  }
}
