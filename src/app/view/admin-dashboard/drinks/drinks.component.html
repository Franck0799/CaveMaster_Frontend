<!-- ========================================
FICHIER: src/app/features/drinks/drinks.component.html
DESCRIPTION: Template HTML pour la gestion des boissons - FORMULAIRE COMPLET
======================================== -->

<div class="drinks-container">

  <!-- ===== EN-T√äTE DE LA PAGE ===== -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">üçæ Mes Boissons</h1>
      <p class="page-subtitle">
        <span *ngIf="selectedCategory" class="active-filter">
          Cat√©gorie : <strong>{{ selectedCategory }}</strong> -
        </span>
        {{ filteredDrinks.length }} produit(s) affich√©(s)
      </p>
    </div>
    <button class="btn btn-primary" (click)="openAddModal()">
      ‚ûï Ajouter une boisson
    </button>
  </header>

  <!-- ===== BARRE DE FILTRES ET RECHERCHE ===== -->
  <section class="filters-section">
    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="üîç Rechercher une boisson..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()">
      <button
        *ngIf="searchTerm"
        class="clear-search-btn"
        (click)="searchTerm = ''; onSearchChange()"
        title="Effacer la recherche">
        ‚úï
      </button>
    </div>

    <div class="category-filter">
      <label class="filter-label">Cat√©gorie :</label>
      <select
        class="category-select"
        [(ngModel)]="selectedCategory"
        (ngModelChange)="onCategoryChange()">
        <option [ngValue]="null">Toutes les cat√©gories</option>
        <option
          *ngFor="let category of drinkCategories"
          [ngValue]="category">
          {{ category }} ({{ getDrinkCountByCategory(category) }})
        </option>
      </select>
    </div>

    <button
      class="btn btn-secondary"
      (click)="resetFilters()"
      *ngIf="selectedCategory || searchTerm">
      üîÑ R√©initialiser
    </button>

    <div class="sort-options">
      <label class="filter-label">Trier par :</label>
      <div class="sort-buttons">
        <button
          class="sort-btn"
          [class.active]="currentSort === 'name'"
          (click)="changeSortCriteria('name')">
          Nom {{ getSortIcon('name') }}
        </button>
        <button
          class="sort-btn"
          [class.active]="currentSort === 'price'"
          (click)="changeSortCriteria('price')">
          Prix {{ getSortIcon('price') }}
        </button>
        <button
          class="sort-btn"
          [class.active]="currentSort === 'stock'"
          (click)="changeSortCriteria('stock')">
          Stock {{ getSortIcon('stock') }}
        </button>
      </div>
    </div>
  </section>

  <!-- ===== INDICATEUR DE CHARGEMENT ===== -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Chargement des boissons...</p>
  </div>

  <!-- ===== MESSAGE SI AUCUN R√âSULTAT ===== -->
  <div *ngIf="!isLoading && filteredDrinks.length === 0" class="no-results">
    <div class="no-results-icon">üîç</div>
    <h3>Aucune boisson trouv√©e</h3>
    <p *ngIf="searchTerm || selectedCategory">
      Essayez de modifier vos crit√®res de recherche
    </p>
    <button class="btn btn-primary" (click)="openAddModal()">
      ‚ûï Ajouter une boisson
    </button>
  </div>

  <!-- ===== GRILLE DES BOISSONS ===== -->
  <section *ngIf="!isLoading && filteredDrinks.length > 0" class="drinks-grid">
    <article
      *ngFor="let drink of filteredDrinks"
      class="drink-card"
      [class.critical-stock]="isCriticalStock(drink.stock)">

      <span
        *ngIf="drink.badge"
        class="drink-badge"
        [ngClass]="'badge-' + drink.badge">
        {{ drink.badge === 'hot' ? 'üî• HOT' : '‚ú® NEW' }}
      </span>

      <span
        *ngIf="isCriticalStock(drink.stock)"
        class="stock-alert-badge">
        ‚ö†Ô∏è Stock faible
      </span>

      <div class="drink-image">
        <div class="drink-icon">{{ drink.icon }}</div>
      </div>

      <div class="drink-info">
        <h3 class="drink-name">{{ drink.name }}</h3>

        <p class="drink-category" [ngClass]="getCategoryClass(drink.category)">
          {{ drink.category }} ‚Ä¢ {{ drink.format }}
        </p>

        <p *ngIf="drink.description" class="drink-description">
          {{ drink.description }}
        </p>

        <div class="drink-stats">
          <div class="stat-item">
            <span class="stat-icon">üí∞</span>
            <span class="stat-value">{{ formatNumber(drink.sellingPrice) }} FCFA/unit√©</span>
          </div>

          <div class="stat-item">
            <span class="stat-icon">üì¶</span>
            <span class="stat-value">
              {{ drink.totalBottles }} bouteilles
              <span [ngClass]="getStockBadge(drink.stock).class" class="stock-badge">
                {{ getStockBadge(drink.stock).label }}
              </span>
            </span>
          </div>

          <div class="stat-item">
            <span class="stat-icon">üè≠</span>
            <span class="stat-value">{{ drink.supplier }}</span>
          </div>
        </div>
      </div>

      <div class="drink-actions">
        <button
          class="btn-icon btn-edit"
          (click)="openEditModal(drink)"
          title="Modifier">
          ‚úèÔ∏è
        </button>
        <button
          class="btn-icon btn-delete"
          (click)="deleteDrink(drink)"
          title="Supprimer">
          üóëÔ∏è
        </button>
      </div>
    </article>
  </section>

  <!-- ===== MODAL AJOUT/MODIFICATION - FORMULAIRE COMPLET ===== -->
  <div *ngIf="isModalOpen" class="modal-overlay" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">

      <header class="modal-header">
        <h2 class="modal-title">
          {{ selectedDrink ? '‚úèÔ∏è Modifier une boisson' : '‚ûï Ajouter une boisson' }}
        </h2>
        <button class="modal-close-btn" (click)="closeModal()">‚úï</button>
      </header>

      <div class="modal-body">
        <form class="drink-form">

          <!-- SECTION 1: INFORMATIONS G√âN√âRALES -->
          <div class="form-section">
            <h3 class="section-title">üìã Informations g√©n√©rales</h3>

            <div class="form-row">
              <!-- Nom de la boisson -->
              <div class="form-group">
                <label class="form-label" for="drink-name">
                  Nom de la boisson <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="drink-name"
                  class="form-input"
                  [(ngModel)]="drinkForm.name"
                  name="name"
                  placeholder="Ex: Heineken"
                  required>
              </div>

              <!-- Format -->
              <div class="form-group">
                <label class="form-label" for="drink-format">
                  Format <span class="required">*</span>
                </label>
                <select
                  id="drink-format"
                  class="form-input"
                  [(ngModel)]="drinkForm.format"
                  name="format"
                  required>
                  <option *ngFor="let format of drinkFormats" [value]="format">
                    {{ format }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <!-- Cat√©gorie -->
              <div class="form-group">
                <label class="form-label" for="drink-category">
                  Cat√©gorie <span class="required">*</span>
                </label>
                <select
                  id="drink-category"
                  class="form-input"
                  [(ngModel)]="drinkForm.category"
                  name="category"
                  required>
                  <option *ngFor="let category of drinkCategories" [value]="category">
                    {{ category }}
                  </option>
                </select>
              </div>

              <!-- Type de conditionnement -->
              <div class="form-group">
                <label class="form-label" for="packaging-type">
                  Type de conditionnement <span class="required">*</span>
                </label>
                <select
                  id="packaging-type"
                  class="form-input"
                  [(ngModel)]="drinkForm.packagingType"
                  name="packagingType"
                  required>
                  <option *ngFor="let type of packagingTypes" [value]="type">
                    {{ type }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Ic√¥ne -->
            <div class="form-group">
              <label class="form-label" for="drink-icon">
                Ic√¥ne (Emoji) <span class="required">*</span>
              </label>
              <input
                type="text"
                id="drink-icon"
                class="form-input"
                [(ngModel)]="drinkForm.icon"
                name="icon"
                placeholder="Ex: üç∑"
                maxlength="2"
                required>
              <small class="form-hint">
                Choisissez un emoji pour repr√©senter la boisson
              </small>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label class="form-label" for="drink-description">
                Description
              </label>
              <textarea
                id="drink-description"
                class="form-textarea"
                [(ngModel)]="drinkForm.description"
                name="description"
                rows="3"
                placeholder="Ajoutez une description..."></textarea>
            </div>
          </div>

          <!-- SECTION 2: FOURNISSEUR ET D√âP√îT -->
          <div class="form-section">
            <h3 class="section-title">üè≠ Fournisseur et d√©p√¥t</h3>

            <div class="form-row">
              <!-- Fournisseur -->
              <div class="form-group">
                <label class="form-label" for="supplier">
                  Fournisseur <span class="required">*</span>
                </label>
                <select
                  id="supplier"
                  class="form-input"
                  [(ngModel)]="drinkForm.supplier"
                  name="supplier"
                  required>
                  <option *ngFor="let supplier of suppliers" [value]="supplier">
                    {{ supplier }}
                  </option>
                </select>
              </div>

              <!-- D√©p√¥t -->
              <div class="form-group">
                <label class="form-label" for="depot">
                  D√©p√¥t qui nous alimente <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="depot"
                  class="form-input"
                  [(ngModel)]="drinkForm.depot"
                  name="depot"
                  placeholder="Ex: D√©p√¥t Abidjan Zone 4"
                  required>
              </div>
            </div>

            <div class="form-row">
              <!-- Nom du commercial -->
              <div class="form-group">
                <label class="form-label" for="commercial-name">
                  Nom du commercial <span class="required">*</span>
                </label>
                <input
                  type="text"
                  id="commercial-name"
                  class="form-input"
                  [(ngModel)]="drinkForm.commercialName"
                  name="commercialName"
                  placeholder="Ex: Kouadio Jean"
                  required>
              </div>

              <!-- Contact du commercial -->
              <div class="form-group">
                <label class="form-label" for="commercial-contact">
                  Contact du commercial <span class="required">*</span>
                </label>
                <input
                  type="tel"
                  id="commercial-contact"
                  class="form-input"
                  [(ngModel)]="drinkForm.commercialContact"
                  name="commercialContact"
                  placeholder="Ex: +225 07 00 00 00 00"
                  required>
              </div>
            </div>
          </div>

          <!-- SECTION 3: QUANTIT√âS -->
          <div class="form-section">
            <h3 class="section-title">üì¶ Quantit√©s et conditionnement</h3>

            <div class="form-row">
              <!-- Unit√© de gros -->
              <div class="form-group">
                <label class="form-label" for="bulk-unit">
                  Unit√© de gros <span class="required">*</span>
                </label>
                <select
                  id="bulk-unit"
                  class="form-input"
                  [(ngModel)]="drinkForm.bulkUnit"
                  name="bulkUnit"
                  (ngModelChange)="calculateTotalBottles()"
                  required>
                  <option *ngFor="let unit of bulkUnits" [value]="unit">
                    {{ unit }}
                  </option>
                </select>
                <small class="form-hint">
                  Carton, Casier, Pack, etc.
                </small>
              </div>

              <!-- Quantit√© en gros -->
              <div class="form-group">
                <label class="form-label" for="bulk-quantity">
                  Quantit√© en gros <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="bulk-quantity"
                  class="form-input"
                  [(ngModel)]="drinkForm.bulkQuantity"
                  name="bulkQuantity"
                  (ngModelChange)="calculateTotalBottles()"
                  min="1"
                  placeholder="Ex: 3"
                  required>
                <small class="form-hint">
                  Nombre de {{ drinkForm.bulkUnit }}s
                </small>
              </div>
            </div>

            <div class="form-row">
              <!-- Quantit√© d√©taill√©e -->
              <div class="form-group">
                <label class="form-label" for="units-per-bulk">
                  Quantit√© d√©taill√©e <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="units-per-bulk"
                  class="form-input"
                  [(ngModel)]="drinkForm.unitsPerBulk"
                  name="unitsPerBulk"
                  (ngModelChange)="calculateTotalBottles()"
                  min="1"
                  placeholder="Ex: 12"
                  required>
                <small class="form-hint">
                  Nombre de bouteilles par {{ drinkForm.bulkUnit }}
                </small>
              </div>

              <!-- Nombre total de bouteilles (calcul√© automatiquement) -->
              <div class="form-group">
                <label class="form-label" for="total-bottles">
                  Nombre total de bouteilles
                </label>
                <input
                  type="number"
                  id="total-bottles"
                  class="form-input form-input-readonly"
                  [(ngModel)]="drinkForm.totalBottles"
                  name="totalBottles"
                  readonly>
                <small class="form-hint calculation-hint">
                  ‚úì Calcul√© automatiquement : {{ drinkForm.bulkQuantity }} √ó {{ drinkForm.unitsPerBulk }} = {{ drinkForm.totalBottles }}
                </small>
              </div>
            </div>
          </div>

          <!-- SECTION 4: PRIX -->
          <div class="form-section">
            <h3 class="section-title">üí∞ Prix et tarification</h3>

            <div class="form-row">
              <!-- Prix d'achat -->
              <div class="form-group">
                <label class="form-label" for="purchase-price">
                  Prix d'achat par bouteille (FCFA) <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="purchase-price"
                  class="form-input"
                  [(ngModel)]="drinkForm.purchasePrice"
                  name="purchasePrice"
                  (ngModelChange)="calculateMargin()"
                  min="0"
                  placeholder="Ex: 650"
                  required>
              </div>

              <!-- Prix de vente -->
              <div class="form-group">
                <label class="form-label" for="selling-price">
                  Prix de vente par bouteille (FCFA) <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="selling-price"
                  class="form-input"
                  [(ngModel)]="drinkForm.sellingPrice"
                  name="sellingPrice"
                  (ngModelChange)="calculateMargin()"
                  min="0"
                  placeholder="Ex: 800"
                  required>
              </div>
            </div>

            <!-- Calcul de marge -->
            <div *ngIf="drinkForm.purchasePrice > 0 && drinkForm.sellingPrice > 0" class="margin-info">
              <div class="margin-card">
                <div class="margin-item">
                  <span class="margin-label">Marge par bouteille :</span>
                  <span class="margin-value" [class.negative]="calculateMargin() < 0">
                    {{ formatNumber(calculateMargin()) }} FCFA
                  </span>
                </div>
                <div class="margin-item">
                  <span class="margin-label">Pourcentage de marge :</span>
                  <span class="margin-value" [class.negative]="calculateMarginPercentage() < 0">
                    {{ calculateMarginPercentage().toFixed(2) }}%
                  </span>
                </div>
                <div class="margin-item">
                  <span class="margin-label">B√©n√©fice total estim√© :</span>
                  <span class="margin-value" [class.negative]="calculateMargin() < 0">
                    {{ formatNumber(calculateMargin() * drinkForm.totalBottles) }} FCFA
                  </span>
                </div>
              </div>
            </div>

            <!-- Stock initial -->
            <div class="form-group">
              <label class="form-label" for="drink-stock">
                Stock initial <span class="required">*</span>
              </label>
              <input
                type="number"
                id="drink-stock"
                class="form-input"
                [(ngModel)]="drinkForm.stock"
                name="stock"
                min="0"
                placeholder="Ex: 150"
                required>
              <small class="form-hint">
                Quantit√© disponible en stock
              </small>
            </div>
          </div>

        </form>
      </div>

      <footer class="modal-footer">
        <button class="btn btn-cancel" (click)="closeModal()">
          Annuler
        </button>
        <button class="btn btn-primary" (click)="saveDrink()">
          {{ selectedDrink ? 'üíæ Enregistrer' : '‚ûï Ajouter' }}
        </button>
      </footer>

    </div>
  </div>

</div>
