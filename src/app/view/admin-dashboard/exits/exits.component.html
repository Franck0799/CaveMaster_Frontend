<!-- ========================================
FICHIER: src/app/view/admin-dashboard/exits/exits.component.html
DESCRIPTION: Template enrichi pour les sorties de stock avec dÃ©tails complets
VERSION ACTUALISÃ‰E
======================================== -->

<div class="exits-container">

  <!-- ===== EN-TÃŠTE ===== -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">ğŸ“¤ Mes Sorties de Stock</h1>
      <p class="page-subtitle">
        Gestion des ventes, transferts et pertes - {{ filteredExits.length }} sortie(s)
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="exportToCSV()">
        ğŸ“Š Exporter
      </button>
      <button class="btn btn-secondary" (click)="printExits()">
        ğŸ–¨ï¸ Imprimer
      </button>
      <button class="btn btn-primary" (click)="openAddModal()">
        â• Nouvelle sortie
      </button>
    </div>
  </header>

  <!-- ===== STATISTIQUES ENRICHIES ===== -->
  <section class="stats-section">
    <div class="stat-card stat-primary">
      <div class="stat-icon">ğŸ“¤</div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalExits }}</div>
        <div class="stat-label">Sorties totales</div>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">ğŸ“‰</div>
      <div class="stat-content">
        <div class="stat-value">{{ formatNumber(stats.totalQuantity) }}</div>
        <div class="stat-label">UnitÃ©s sorties</div>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">ğŸ’°</div>
      <div class="stat-content">
        <div class="stat-value">{{ formatNumber(stats.totalRevenue) }} F</div>
        <div class="stat-label">Revenus (ventes)</div>
      </div>
    </div>

    <div class="stat-card stat-danger">
      <div class="stat-icon">âŒ</div>
      <div class="stat-content">
        <div class="stat-value">{{ formatNumber(stats.totalLoss) }} F</div>
        <div class="stat-label">Pertes totales</div>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon">ğŸ’µ</div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.averageMargin }}%</div>
        <div class="stat-label">Marge moyenne</div>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">ğŸ›’</div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.salesCount }}</div>
        <div class="stat-label">Nombre de ventes</div>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon">ğŸ”„</div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.transfersCount }}</div>
        <div class="stat-label">Transferts</div>
      </div>
    </div>

    <div class="stat-card stat-warning" *ngIf="stats.topCustomer">
      <div class="stat-icon">ğŸ‘¤</div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.topCustomer }}</div>
        <div class="stat-label">Meilleur client</div>
      </div>
    </div>
  </section>

  <!-- ===== FILTRES ENRICHIS ===== -->
  <section class="filters-section">
    <!-- Recherche -->
    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="ğŸ” Rechercher par boisson, client, facture..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()">
      <button
        *ngIf="searchTerm"
        class="clear-btn"
        (click)="searchTerm = ''; onSearchChange()">âœ•</button>
    </div>

    <!-- Filtre par cave -->
    <div class="filter-group">
      <label class="filter-label">Cave :</label>
      <select
        class="filter-select"
        [(ngModel)]="selectedCaveFilter"
        (ngModelChange)="onCaveFilterChange()">
        <option [ngValue]="null">Toutes les caves</option>
        <option *ngFor="let cave of caves" [ngValue]="cave.id">
          ğŸ“ {{ cave.name }}
        </option>
      </select>
    </div>

    <!-- Filtre par type -->
    <div class="filter-group">
      <label class="filter-label">Type :</label>
      <select
        class="filter-select"
        [(ngModel)]="selectedTypeFilter"
        (ngModelChange)="onTypeFilterChange()">
        <option [ngValue]="null">Tous les types</option>
        <option *ngFor="let type of exitTypes" [ngValue]="type">
          {{ getTypeLabel(type) }}
        </option>
      </select>
    </div>

    <!-- Filtre par catÃ©gorie -->
    <div class="filter-group">
      <label class="filter-label">CatÃ©gorie :</label>
      <select
        class="filter-select"
        [(ngModel)]="selectedCategoryFilter"
        (ngModelChange)="onCategoryFilterChange()">
        <option [ngValue]="null">Toutes les catÃ©gories</option>
        <option *ngFor="let category of drinkCategories" [ngValue]="category">
          {{ category }}
        </option>
      </select>
    </div>

    <!-- Filtre par pÃ©riode -->
    <div class="filter-group">
      <label class="filter-label">PÃ©riode :</label>
      <select
        class="filter-select"
        [(ngModel)]="periodFilter"
        (ngModelChange)="onPeriodFilterChange()">
        <option [value]="7">7 derniers jours</option>
        <option [value]="30">30 derniers jours</option>
        <option [value]="90">3 derniers mois</option>
        <option [value]="0">Toutes les sorties</option>
      </select>
    </div>

    <!-- Bouton de rÃ©initialisation -->
    <button
      class="btn btn-secondary"
      (click)="resetFilters()"
      *ngIf="selectedCaveFilter || selectedTypeFilter || selectedCategoryFilter || searchTerm">
      ğŸ”„ RÃ©initialiser
    </button>
  </section>

  <!-- ===== CHARGEMENT ===== -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Chargement des sorties...</p>
  </div>

  <!-- ===== AUCUN RÃ‰SULTAT ===== -->
  <div *ngIf="!isLoading && filteredExits.length === 0" class="no-results">
    <div class="no-results-icon">ğŸ“¤</div>
    <h3>Aucune sortie trouvÃ©e</h3>
    <p *ngIf="searchTerm || selectedCaveFilter || selectedTypeFilter || selectedCategoryFilter">
      Aucune sortie ne correspond Ã  vos critÃ¨res
    </p>
    <p *ngIf="!searchTerm && !selectedCaveFilter && !selectedTypeFilter && !selectedCategoryFilter">
      Commencez par enregistrer votre premiÃ¨re sortie de stock
    </p>
    <button class="btn btn-primary" (click)="openAddModal()">
      â• Nouvelle sortie
    </button>
  </div>

  <!-- ===== TABLEAU DES SORTIES ENRICHI ===== -->
  <section *ngIf="!isLoading && filteredExits.length > 0" class="exits-table">
    <div class="table-wrapper">
      <table class="data-table">
        <!-- En-tÃªtes -->
        <thead>
          <tr>
            <th>Date</th>
            <th>Boisson</th>
            <th>Type</th>
            <th>CatÃ©gorie</th>
            <th class="text-center">QuantitÃ©</th>
            <th class="text-right">Prix Unit.</th>
            <th class="text-right">Montant</th>
            <th>Client/Destination</th>
            <th>Cave</th>
            <th class="text-right">Marge</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>

        <!-- Corps -->
        <tbody>
          <tr *ngFor="let exit of filteredExits"
              class="table-row"
              [class.recent-exit]="isRecentExit(exit)"
              [class.loss-row]="isLoss(exit)">

            <!-- Date -->
            <td class="date-cell">
              <div class="date-main">
                {{ formatDate(exit.date).split(' Ã  ')[0] }}
              </div>
              <div class="date-relative">{{ getRelativeDate(exit.date) }}</div>
            </td>

            <!-- Boisson avec icÃ´ne -->
            <td class="drink-cell">
              <div class="drink-info">
                <span class="drink-icon">{{ exit.drinkIcon }}</span>
                <div>
                  <div class="drink-name">{{ exit.drinkName }}</div>
                  <div class="drink-format">{{ exit.drinkFormat }}</div>
                </div>
              </div>
            </td>

            <!-- Type avec badge colorÃ© -->
            <td>
              <span class="type-badge" [ngClass]="getTypeClass(exit.type)">
                {{ getTypeIcon(exit.type) }} {{ getTypeLabel(exit.type).split(' ')[1] }}
              </span>
            </td>

            <!-- CatÃ©gorie -->
            <td>
              <span class="category-badge" [ngClass]="getCategoryClass(exit.drinkCategory)">
                {{ exit.drinkCategory }}
              </span>
            </td>

            <!-- QuantitÃ© -->
            <td class="text-center quantity-cell">
              <span class="quantity-badge">
                {{ exit.quantity }}
              </span>
            </td>

            <!-- Prix unitaire -->
            <td class="text-right">
              {{ formatNumber(exit.unitPrice) }} F
            </td>

            <!-- Montant total -->
            <td class="text-right total-cell">
              <strong [class.revenue]="exit.type === 'vente'"
                      [class.loss]="isLoss(exit)">
                {{ formatNumber(exit.totalAmount) }} F
              </strong>
            </td>

            <!-- Client/Destination -->
            <td class="destination-cell">
              <div class="destination-info">
                <div class="destination-main" *ngIf="exit.customer">ğŸ‘¤ {{ exit.customer }}
                </div>
                <div class="destination-secondary" *ngIf="!exit.customer && exit.destination">
                  {{ exit.destination }}
                </div>
                <div class="destination-secondary" *ngIf="exit.transferToCaveId">
                  ğŸ”„ {{ getCaveName(exit.transferToCaveId) }}
                </div>
              </div>
            </td>

            <!-- Cave source -->
            <td class="cave-cell">
              <span class="cave-badge">
                ğŸ“ {{ getCaveName(exit.caveId) }}
              </span>
            </td>

            <!-- Marge -->
            <td class="text-right margin-cell">
              <div *ngIf="exit.type === 'vente'" class="margin-info">
                <div class="margin-amount">
                  {{ formatNumber(calculateMargin(exit)) }} F
                </div>
                <div class="margin-rate"
                     [class.margin-good]="calculateMarginRate(exit) >= 20"
                     [class.margin-medium]="calculateMarginRate(exit) >= 10 && calculateMarginRate(exit) < 20"
                     [class.margin-low]="calculateMarginRate(exit) < 10">
                  {{ calculateMarginRate(exit) }}%
                </div>
              </div>
              <span *ngIf="exit.type !== 'vente'" class="margin-na">â€”</span>
            </td>

            <!-- Actions -->
            <td class="text-center actions-cell">
              <button
                class="btn-icon"
                title="Voir les dÃ©tails"
                (click)="viewExitDetails(exit)">
                ğŸ‘ï¸
              </button>
              <button
                class="btn-icon btn-danger"
                title="Supprimer"
                (click)="deleteExit(exit)">
                ğŸ—‘ï¸
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===== MODAL AJOUT DE SORTIE ENRICHI ===== -->
  <div *ngIf="isAddModalOpen" class="modal-overlay" (click)="closeAddModal()">
    <div class="modal-container modal-large" (click)="$event.stopPropagation()">

      <!-- En-tÃªte -->
      <header class="modal-header">
        <h2 class="modal-title">â• Nouvelle Sortie de Stock</h2>
        <button class="modal-close-btn" (click)="closeAddModal()">âœ•</button>
      </header>

      <!-- Corps -->
      <div class="modal-body">
        <form class="exit-form">

          <!-- SECTION 1: SÃ‰LECTION BOISSON ET TYPE -->
          <div class="form-section">
            <h3 class="section-title">ğŸ“¦ Produit et type de sortie</h3>

            <div class="form-group">
              <label class="form-label" for="exit-drink">
                Boisson <span class="required">*</span>
              </label>
              <select
                id="exit-drink"
                class="form-input"
                [(ngModel)]="exitForm.drinkId"
                name="drinkId"
                (ngModelChange)="onDrinkSelected()"
                required>
                <option value="">SÃ©lectionner une boisson...</option>
                <option *ngFor="let drink of drinks" [value]="drink.id">
                  {{ drink.icon }} {{ drink.name }} ({{ drink.format }}) - Stock: {{ drink.stock }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="exit-type">
                Type de sortie <span class="required">*</span>
              </label>
              <select
                id="exit-type"
                class="form-input"
                [(ngModel)]="exitForm.type"
                name="type"
                (ngModelChange)="onTypeChange()"
                required>
                <option *ngFor="let type of exitTypes" [value]="type">
                  {{ getTypeLabel(type) }}
                </option>
              </select>
              <small class="helper-text">
                <span *ngIf="exitForm.type === 'vente'">ğŸ’¡ Pour une vente Ã  un client</span>
                <span *ngIf="exitForm.type === 'transfert'">ğŸ’¡ Pour un transfert vers une autre cave</span>
                <span *ngIf="exitForm.type === 'perte'">ğŸ’¡ Pour une perte de stock</span>
                <span *ngIf="exitForm.type === 'casse'">ğŸ’¡ Pour des produits cassÃ©s</span>
                <span *ngIf="exitForm.type === 'peremption'">ğŸ’¡ Pour des produits pÃ©rimÃ©s</span>
                <span *ngIf="exitForm.type === 'degustation'">ğŸ’¡ Pour une dÃ©gustation</span>
              </small>
            </div>
          </div>

          <!-- SECTION 2: QUANTITÃ‰ ET TARIFICATION -->
          <div class="form-section" *ngIf="exitForm.drinkId">
            <h3 class="section-title">ğŸ”¢ QuantitÃ© et tarification</h3>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="exit-quantity">
                  QuantitÃ© <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="exit-quantity"
                  class="form-input"
                  [(ngModel)]="exitForm.quantity"
                  name="quantity"
                  min="1"
                  (ngModelChange)="calculateTotalAmount()"
                  placeholder="Ex: 24"
                  required>
              </div>

              <div class="form-group">
                <label class="form-label" for="exit-price">
                  Prix unitaire (FCFA) <span class="required">*</span>
                </label>
                <input
                  type="number"
                  id="exit-price"
                  class="form-input"
                  [(ngModel)]="exitForm.unitPrice"
                  name="unitPrice"
                  min="0"
                  (ngModelChange)="calculateTotalAmount()"
                  placeholder="Ex: 800"
                  required>
              </div>
            </div>

            <!-- Montant total calculÃ© -->
            <div class="total-amount-display" [class.revenue-display]="exitForm.type === 'vente'">
              <span class="total-label">
                {{ exitForm.type === 'vente' ? 'ğŸ’µ Montant de la vente' : 'ğŸ’° Montant total' }} :
              </span>
              <span class="total-value">
                {{ formatNumber(exitForm.totalAmount) }} FCFA
              </span>
            </div>
          </div>

          <!-- SECTION 3: CAVE SOURCE -->
          <div class="form-section">
            <h3 class="section-title">ğŸ“ Cave source</h3>

            <div class="form-group">
              <label class="form-label" for="exit-cave">
                Cave de prÃ©lÃ¨vement <span class="required">*</span>
              </label>
              <select
                id="exit-cave"
                class="form-input"
                [(ngModel)]="exitForm.caveId"
                name="caveId"
                required>
                <option value="">SÃ©lectionner une cave...</option>
                <option *ngFor="let cave of caves" [value]="cave.id">
                  ğŸ“ {{ cave.name }} - {{ cave.location }}
                </option>
              </select>
            </div>
          </div>

          <!-- SECTION 4: DESTINATION (selon le type) -->

          <!-- Pour VENTE : Client -->
          <div class="form-section" *ngIf="exitForm.type === 'vente'">
            <h3 class="section-title">ğŸ‘¤ Informations client</h3>

            <div class="form-group">
              <label class="form-label" for="exit-customer">
                Nom du client <span class="required">*</span>
              </label>
              <input
                type="text"
                id="exit-customer"
                class="form-input"
                [(ngModel)]="exitForm.customer"
                name="customer"
                placeholder="Ex: Restaurant Le Gourmet"
                required>
            </div>

            <div class="form-group">
              <label class="form-label" for="exit-customer-contact">
                Contact du client
              </label>
              <input
                type="text"
                id="exit-customer-contact"
                class="form-input"
                [(ngModel)]="exitForm.customerContact"
                name="customerContact"
                placeholder="Ex: +225 07 00 00 00 00">
            </div>

            <div class="form-group">
              <label class="form-label" for="exit-destination">
                Adresse de livraison
              </label>
              <input
                type="text"
                id="exit-destination"
                class="form-input"
                [(ngModel)]="exitForm.destination"
                name="destination"
                placeholder="Ex: Cocody, Rue des Jardins">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="exit-invoice">
                  NumÃ©ro de facture
                </label>
                <input
                  type="text"
                  id="exit-invoice"
                  class="form-input"
                  [(ngModel)]="exitForm.invoiceNumber"
                  name="invoiceNumber"
                  placeholder="Ex: FACT-2024-001">
              </div>

              <div class="form-group">
                <label class="form-label" for="exit-delivery">
                  Bon de livraison
                </label>
                <input
                  type="text"
                  id="exit-delivery"
                  class="form-input"
                  [(ngModel)]="exitForm.deliveryNote"
                  name="deliveryNote"
                  placeholder="Ex: BL-2024-001">
              </div>
            </div>
          </div>

          <!-- Pour TRANSFERT : Cave destination -->
          <div class="form-section" *ngIf="exitForm.type === 'transfert'">
            <h3 class="section-title">ğŸ”„ Cave de destination</h3>

            <div class="form-group">
              <label class="form-label" for="exit-transfer-cave">
                Cave de destination <span class="required">*</span>
              </label>
              <select
                id="exit-transfer-cave"
                class="form-input"
                [(ngModel)]="exitForm.transferToCaveId"
                name="transferToCaveId"
                required>
                <option value="">SÃ©lectionner une cave...</option>
                <option *ngFor="let cave of caves"
                        [value]="cave.id"
                        [disabled]="cave.id === exitForm.caveId">
                  ğŸ“ {{ cave.name }} - {{ cave.location }}
                </option>
              </select>
              <small class="helper-text">
                ğŸ’¡ La cave de destination doit Ãªtre diffÃ©rente de la cave source
              </small>
            </div>
          </div>

          <!-- Pour PERTE/CASSE/PÃ‰REMPTION : Motif -->
          <div class="form-section" *ngIf="['perte', 'casse', 'peremption'].includes(exitForm.type)">
            <h3 class="section-title">âš ï¸ Informations sur la {{ exitForm.type }}</h3>

            <div class="form-group">
              <label class="form-label" for="exit-loss-reason">
                Motif de la {{ exitForm.type }} <span class="required">*</span>
              </label>
              <textarea
                id="exit-loss-reason"
                class="form-textarea"
                [(ngModel)]="exitForm.lossReason"
                name="lossReason"
                rows="3"
                placeholder="DÃ©crivez la raison de la {{ exitForm.type }}..."
                required></textarea>
            </div>

            <div class="form-group" *ngIf="exitForm.type === 'casse'">
              <label class="form-label" for="exit-breakage">
                DÃ©tails de la casse
              </label>
              <textarea
                id="exit-breakage"
                class="form-textarea"
                [(ngModel)]="exitForm.breakageDetails"
                name="breakageDetails"
                rows="3"
                placeholder="Circonstances de la casse, responsabilitÃ©..."></textarea>
            </div>
          </div>

          <!-- Pour DÃ‰GUSTATION : DÃ©tails -->
          <div class="form-section" *ngIf="exitForm.type === 'degustation'">
            <h3 class="section-title">ğŸ· Informations sur la dÃ©gustation</h3>

            <div class="form-group">
              <label class="form-label" for="exit-tasting-destination">
                Ã‰vÃ©nement / Clients
              </label>
              <input
                type="text"
                id="exit-tasting-destination"
                class="form-input"
                [(ngModel)]="exitForm.destination"
                name="destination"
                placeholder="Ex: SÃ©ance de dÃ©gustation clients VIP">
            </div>

            <div class="form-group">
              <label class="form-label" for="exit-tasting-customer">
                Participants
              </label>
              <input
                type="text"
                id="exit-tasting-customer"
                class="form-input"
                [(ngModel)]="exitForm.customer"
                name="customer"
                placeholder="Ex: 15 clients VIP">
            </div>
          </div>

          <!-- SECTION 5: NOTES -->
          <div class="form-section">
            <h3 class="section-title">ğŸ“ Notes et commentaires</h3>

            <div class="form-group">
              <label class="form-label" for="exit-notes">
                Notes ou observations
              </label>
              <textarea
                id="exit-notes"
                class="form-textarea"
                [(ngModel)]="exitForm.notes"
                name="notes"
                rows="4"
                placeholder="Ajoutez des notes sur cette sortie..."></textarea>
            </div>
          </div>

          <!-- SECTION 6: SUGGESTIONS D'ACCORDS (pour ventes) -->
          <div class="form-section" *ngIf="exitForm.type === 'vente' && winePairingSuggestions.length > 0">
            <h3 class="section-title">ğŸ½ï¸ Suggestions pour votre client</h3>
            <p class="section-description">
              Recommandations d'accords mets-vins Ã  partager avec votre client :
            </p>

            <div class="wine-pairing-suggestions">
              <div class="pairing-card" *ngFor="let suggestion of winePairingSuggestions">
                <div class="pairing-icon">{{ suggestion.dishIcon }}</div>
                <div class="pairing-content">
                  <h4 class="pairing-dish">{{ suggestion.dish }}</h4>
                  <p class="pairing-description">{{ suggestion.description }}</p>
                  <div class="pairing-temperature">
                    ğŸŒ¡ï¸ Servir Ã  {{ suggestion.temperature }}
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- Pied -->
      <footer class="modal-footer">
        <button class="btn btn-cancel" (click)="closeAddModal()">
          Annuler
        </button>
        <button class="btn btn-primary" (click)="saveExit()">
          ğŸ’¾ Enregistrer la sortie
        </button>
      </footer>

    </div>
  </div>

  <!-- ===== MODAL DÃ‰TAILS DE SORTIE ===== -->
  <div *ngIf="isDetailModalOpen && selectedExit" class="modal-overlay" (click)="closeDetailModal()">
    <div class="modal-container modal-large" (click)="$event.stopPropagation()">

      <!-- En-tÃªte -->
      <header class="modal-header">
        <h2 class="modal-title">
          {{ selectedExit.drinkIcon }} DÃ©tails de la sortie - {{ selectedExit.drinkName }}
        </h2>
        <button class="modal-close-btn" (click)="closeDetailModal()">âœ•</button>
      </header>

      <!-- Corps -->
      <div class="modal-body">
        <div class="details-content">

          <!-- Informations gÃ©nÃ©rales -->
          <div class="detail-section">
            <h3 class="detail-section-title">ğŸ“¦ Informations gÃ©nÃ©rales</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Date de sortie :</span>
                <span class="detail-value">{{ formatDate(selectedExit.date) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Type :</span>
                <span class="detail-value badge" [ngClass]="getTypeClass(selectedExit.type)">
                  {{ getTypeLabel(selectedExit.type) }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Boisson :</span>
                <span class="detail-value">
                  {{ selectedExit.drinkIcon }} {{ selectedExit.drinkName }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">CatÃ©gorie :</span>
                <span class="detail-value badge" [ngClass]="getCategoryClass(selectedExit.drinkCategory)">
                  {{ selectedExit.drinkCategory }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Format :</span>
                <span class="detail-value">{{ selectedExit.drinkFormat }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Cave source :</span>
                <span class="detail-value">ğŸ“ {{ getCaveName(selectedExit.caveId) }}</span>
              </div>
            </div>
          </div>

          <!-- QuantitÃ© et tarification -->
          <div class="detail-section">
            <h3 class="detail-section-title">ğŸ’° QuantitÃ© et tarification</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">QuantitÃ© :</span>
                <span class="detail-value highlight">{{ selectedExit.quantity }} unitÃ©s</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Prix unitaire :</span>
                <span class="detail-value">{{ formatNumber(selectedExit.unitPrice) }} FCFA</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Montant total :</span>
                <span class="detail-value highlight-success">
                  {{ formatNumber(selectedExit.totalAmount) }} FCFA
                </span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.type === 'vente'">
                <span class="detail-label">Marge rÃ©alisÃ©e :</span>
                <span class="detail-value highlight-success">
                  {{ formatNumber(calculateMargin(selectedExit)) }} FCFA ({{ calculateMarginRate(selectedExit) }}%)
                </span>
              </div>
            </div>
          </div>

          <!-- Client (vente) -->
          <div class="detail-section" *ngIf="selectedExit.type === 'vente' && selectedExit.customer">
            <h3 class="detail-section-title">ğŸ‘¤ Informations client</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Client :</span>
                <span class="detail-value">{{ selectedExit.customer }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.customerContact">
                <span class="detail-label">Contact :</span>
                <span class="detail-value">{{ selectedExit.customerContact }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.destination">
                <span class="detail-label">Adresse :</span>
                <span class="detail-value">{{ selectedExit.destination }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.invoiceNumber">
                <span class="detail-label">Facture :</span>
                <span class="detail-value">ğŸ“„ {{ selectedExit.invoiceNumber }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.deliveryNote">
                <span class="detail-label">Bon de livraison :</span>
                <span class="detail-value">ğŸ“‹ {{ selectedExit.deliveryNote }}</span>
              </div>
            </div>
          </div>

          <!-- Transfert -->
          <div class="detail-section" *ngIf="selectedExit.type === 'transfert' && selectedExit.transferToCaveId">
            <h3 class="detail-section-title">ğŸ”„ Informations de transfert</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Cave source :</span>
                <span class="detail-value">ğŸ“ {{ getCaveName(selectedExit.caveId) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Cave destination :</span>
                <span class="detail-value">ğŸ“ {{ getCaveName(selectedExit.transferToCaveId) }}</span>
              </div>
            </div>
          </div>

          <!-- Perte/Casse/PÃ©remption -->
          <div class="detail-section" *ngIf="isLoss(selectedExit)">
            <h3 class="detail-section-title">âš ï¸ Informations sur la {{ selectedExit.type }}</h3>
            <div class="detail-grid">
              <div class="detail-item full-width" *ngIf="selectedExit.lossReason">
                <span class="detail-label">Motif :</span>
                <span class="detail-value">{{ selectedExit.lossReason }}</span>
              </div>
              <div class="detail-item full-width" *ngIf="selectedExit.breakageDetails">
                <span class="detail-label">DÃ©tails de la casse :</span>
                <span class="detail-value">{{ selectedExit.breakageDetails }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedExit.expiryDate">
                <span class="detail-label">Date de pÃ©remption :</span>
                <span class="detail-value">
                  {{ formatDate(selectedExit.expiryDate).split(' Ã  ')[0] }}
                </span>
              </div>
            </div>
          </div>

          <!-- TraitÃ© par -->
          <div class="detail-section">
            <h3 class="detail-section-title">ğŸ‘¨â€ğŸ’¼ Traitement</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">TraitÃ© par :</span>
                <span class="detail-value">{{ selectedExit.processedByName || selectedExit.processedBy }}</span>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="detail-section" *ngIf="selectedExit.notes">
            <h3 class="detail-section-title">ğŸ“ Notes</h3>
            <div class="detail-notes">
              {{ selectedExit.notes }}
            </div>
          </div>

          <!-- Suggestions d'accords (ventes) -->
          <div class="detail-section" *ngIf="selectedExit.type === 'vente' && winePairingSuggestions.length > 0">
            <h3 class="detail-section-title">ğŸ½ï¸ Suggestions d'accords mets-vins</h3>
            <div class="wine-pairing-suggestions">
              <div class="pairing-card" *ngFor="let suggestion of winePairingSuggestions">
                <div class="pairing-icon">{{ suggestion.dishIcon }}</div>
                <div class="pairing-content">
                  <h4 class="pairing-dish">{{ suggestion.dish }}</h4>
                  <p class="pairing-description">{{ suggestion.description }}</p>
                  <div class="pairing-temperature">
                    ğŸŒ¡ï¸ Servir Ã  {{ suggestion.temperature }}
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Pied -->
      <footer class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetailModal()">
          Fermer
        </button>
      </footer>

    </div>
  </div>

</div>
